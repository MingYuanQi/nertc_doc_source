为了防止网页在用户非自愿的情况下自动播放声音，通常情况下浏览器会限制自动播放功能（Autoplay），即在没有用户交互操作之前，不允许播放有声媒体。为解决浏览器限制导致的自动播放问题，本文为您介绍处理自动播放受限的方案。

## 推荐方案

网易云信推荐以下方式处理浏览器自动播放受限问题：

- 播放失败时，引导用户手动恢复播放
- 直接解除自动播放功能受限

同时，根据不同的移动终端，推荐以下处理方式：

- iOS：由于 iOS Safari/WebView 只允许通过用户交互触发有声媒体的播放，对于 iOS Safari/WebView 应用，推荐 [播放失败时手动恢复](#播放失败时手动恢复) 方式。
- 安卓：使用安卓端微信浏览器先入会的用户，可能无法正常播放其他后入会用户的音视频，推荐 [直接解除自动播放受限](#直接解除自动播放受限) 方式。

## 播放失败时手动恢复

如果出现浏览器自动播放策略导致的音视频播放失败，可以使用 `onError` 监听 `41030` 错误。

监听到 `41030` 错误之后，您可以引导用户进行手势交互，调用 `engine.resume` 恢复音视频正常播放。

```JavaScript
this.engine.addEventListener("onError", (code, message, extraInfo) => {
    let imessage = `onError 通知：code = ${code}, message = ${message}, extraInfo = ${extraInfo}`
    console.log(imessage)
    if (code === 41030) {
        imessage = `${extraInfo.userID} 音频播放收到浏览器限制需要用户手势触发 `
        //在界面上弹出按钮或者别的元素，然后执行 this.engine.resume()方法恢复播放，参考 H5 平台支持中的代码（Demo 上也有体现）
        this.isResumeAudio = true
        console.log(imessage)
    }
});
```

## 直接解除自动播放受限

大部分浏览器在用户交互之后就放开了 AutoPlay 限制，通过提前引导用户和页面产生交互行为的方式，可以有效的规避 **桌面端** 以及 **安卓设备** 上的自动播放受限问题。此时确保在通过弹窗指引或者按钮单击等方式，要求用户和页面发生交互行为之后，调用 sdk 的 `rePlayAudio` 接口。

1. 在代码开始处，为页面添加交互监听事件。例如监听单击操作或监听触摸操作。

    - 监听单击操作

        ```JavaScript
        document.addEventListener('mousedown', replay) // 监听单击操作
        ```
    - 监听触摸操作
        ```JavaScript
        document.addEventListener('touchstart', replay) // 监听触摸操作
        ```

2. 当页面监听到 `mousedown` 或者 `touchstart` 事件后，执行回调函数。

    ```JavaScript
    let replay = () => {
        this.engine.rePlayAudio()
        // 移除鼠标/触屏监听事件
        // document.removeEventListener('mousedown', replay);
        // document.removeEventListener('touchstart', replay)
    }
    ```