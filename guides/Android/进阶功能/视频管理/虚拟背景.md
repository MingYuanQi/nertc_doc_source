<!--keywords: 背景分割,虚拟背景-->

在音视频会议或教育场景中，为了突出人像或者保护隐私，用户不想将视窗的背景呈现出来。NERTC SDK 通过自动识别用户人像，虚化用户周围的真实环境，或者以指定颜色的图片或自定义图像替代真实背景，从而实现设置虚拟背景。替换后，频道内所有远端用户都能看到本地用户自定义的虚拟背景。

::: note note
- **自 V4.6.20 起**，虚拟背景功能支持**插件化**集成，请在集成时按需引入虚拟背景库 `libNERtcPersonSegment.so`，具体集成方式请参考<a href="/docs/jcyOTA0ODM/DcyNDc0ODI" target="_blank">集成 SDK</a>。
- 虚拟背景功能暂时为 beta 测试版，建议您先在测试环境中试用，效果满意再集成上线。
:::

## 前提条件
- V5.5.0 之前的版本，请联系网易云信技术支持，开通**虚拟背景**功能。
- V5.5.0 及之后版本，您可以直接使用**虚拟背景**功能，无需人工开通。

## 功能原理

NERTC SDK 支持的虚拟背景采用自研的深度学习算法，在对当前视频帧做背景分割时利用前一帧的分割结果作为先验信息，同时在 video matting 中利用时序信息解决视频分割中可能出现的闪烁问题，提升分割效果，让您在使用虚拟背景的同时也能享受优质的视频通话体验。

## 注意事项

- 建议您在满足以下条件的场景中使用虚拟背景功能：
    - 采用高清摄像设备，避免遮挡摄像头且环境光线均匀。
    - 捕获的视频场景中无冗余物件，用户人像尽量保持上半身在画面内且基本无遮挡。
    - 背景色单一且尽量不与用户着装颜色相同。
- 对上传自定义图像的要求：
    - 纯色图片的格式为 RGB 定义的十六进制整数，不带 # 号。
    - 自定义背景图片支持 JPG 和 PNG 格式。
- 若您设置背景图片为自定义本地图片，SDK 会在保证背景图片内容不变形的前提下，对图片进行一定程度上的缩放和裁剪，以适配视频采集分辨率。
- 暂不支持在 Texture 格式的视频或通过 Push 方法从自定义视频源获取的视频中设置虚拟背景。

## 实现方法

1. 在成功加入房间后调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc.html#ad5c6e217dacfc20546617d98e3b5ba9b" target="_blank">`enableLocalVideo`</a> 方法开启本地视频采集。
    ::: note notice
    调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc.html#ad5c6e217dacfc20546617d98e3b5ba9b" target="_blank">`enableLocalVideo`</a> 开启本地视频采集时，请设置 `streamType` 参数为 `kNERtcVideoStreamTypeMain`，否则虚拟背景效果不会生效。
    :::
2. 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#ad1b6de36f54e4c9c3ab04249c89c4906" target="_blank">`enableVirtualBackground`</a> 方法开启虚拟背景功能。调用该方法时，您需要设置 `enabled` 参数为 `true` 开启虚拟背景功能，并设置 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1video_1_1_n_e_rtc_virtual_background_source.html#a751ef7531e7b08cbb8d6a59b1450f5be" target="_blank">`backgroundSource`</a> 参数自定义背景图片的类型。
    - 设置背景图片为纯色图像（默认）：您需要设置 `backgroundSourceType` 参数为 `BACKGROUND_COLOR`；并设置 `color` 参数自定义图像颜色，该参数的取值范围为 0x000000 ~ 0xFFFFFF，默认值为 0xFFFFFF，即白色。
    ::: note note
    若 `color` 值设置无效，SDK 会将背景图片设置为白色图片。
    :::
    - 设置背景图片为自定义本地图片：您需要设置 `backgroundSourceType` 参数为 `BACKGROUND_IMG`；并设置 `source` 参数为自定义背景图片的本地绝对路径。
    - 设置背景虚化：您需要设置 `backgroundSourceType` 参数为 `BACKGROUND_BLUR`；并设置 `blur_degree` 参数指定虚化程度，具体枚举值如下：
        - 虚化程度低：BLUR_DEGREE_LOW（1）。
        - 虚化程度中：BLUR_DEGREE_MEDIUM（2）。
        - 虚化程度高：BLUR_DEGREE_HIGH（3）。
3. 启用该方法后，SDK 会触发虚拟背景启用成功与否的 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_callback_ex.html#aaa70fbf1467e098754e0f2290b779dc5" target="_blank">`onVirtualBackgroundSourceEnabled`</a> 回调，并提供相关错误原因说明，具体请参考 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_constants_1_1_n_e_rtc_virtual_background_source_state_reason.html" target="_blank">`NERtcVirtualBackgroundSourceStateReason`</a>。


    ::: note note
    如果状态码提示设备不支持，请联系网易云信技术支持获取帮助。
    :::


  
4. 若您需要取消虚拟背景，请调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#ad1b6de36f54e4c9c3ab04249c89c4906" target="_blank">`enableVirtualBackground`</a> 方法，设置 `enabled` 参数为 `false`，关闭虚拟背景功能。

## 示例项目源码

网易云信提供[虚拟背景的示例项目源码 VirtualBackground](https://github.com/netease-im/G2-API-Examples/tree/main/android/VideoCapability/VirtualBackground)，您可以参考该源码实现虚拟背景。

## 示例代码

```
//以设置虚拟背景为自定义本地图片为例
// step 1: 初始化背景
private NERtcVirtualBackgroundSource virtualBackgroundSource = new NERtcVirtualBackgroundSource();
mVirtualBackgroundSource.backgroundSourceType = NERtcVirtualBackgroundSource.BACKGROUND_IMG; //设置虚拟背景类型
mVirtualBackgroundSource.source = virtualBgImgPath; //设置背景图片路径

// step2: 开启虚拟背景
NERtcEx.getInstance().enableVirtualBackground(true, virtualBackgroundSource);

// step3: 关闭虚拟背景
NERtcEx.getInstance().enableVirtualBackground(false, null);
```

## API 参考
| **方法** | **功能描述**|
|:--|:--|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc.html#ad5c6e217dacfc20546617d98e3b5ba9b" target="_blank">`enableLocalVideo`</a>|开启本地视频采集。|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#ad1b6de36f54e4c9c3ab04249c89c4906" target="_blank">`enableVirtualBackground`</a>|开启或关闭虚拟背景。|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_callback_ex.html#aaa70fbf1467e098754e0f2290b779dc5" target="_blank">`onVirtualBackgroundSourceEnabled`</a>|是否成功启用虚拟背景的回调通知。|
