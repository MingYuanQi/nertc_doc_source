<!--keywords:音视频通话,纯传输通道,编码后数据传输,裸流传输 -->

在一些需要与硬件配合的应用场景中，比如使用教室硬件设备进行线上教学，在利用硬件自身能力进行视频采集、编码的基础上，还需要良好的抗弱网传输能力。为了帮助拥有第三方视频编解码模块或自研编解码的开发者实现实时视频码流传输互通，NERTC SDK 为用户提供抗弱网、抗丢包的纯传输通道。

## 功能介绍

依托网易云信底层实时传输网络 WE-CAN（Communication Acceleration Network），NERTC 运用全球节点及抗弱网算法，提供低延时、高稳定性的音视频码流传输通道，大大减少延时、丢包等网络问题对音视频传输质量和体验的影响。

NERTC SDK 支持视频裸流传输，您可以向 NERTC SDK 提供自定义的 H.264 等格式的视频编码数据，并由 NERTC SDK 进行推流。

## 注意事项

使用 NERTC SDK 提供的裸流传输通道时，您需要自行管理视频流的采集、编解码、渲染和其他处理。

## 发送视频裸流

### 实现方法

1. 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#a95c76b8256518dbbadd8bd6a50c422c1" target="_blank">`setVideoStreamLayerCount`</a> 方法设置视频流的模式；调用此方法时，您需要设置 `layerCount` 参数为 `kNERtcVideoStreamLayerCountOne`，开启单流模式。
2. 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#a0b6f78498f4dfa59697af30679130f02" target="_blank">`setExternalVideoSource`</a> 方法开启外部视频源数据输入；调用此方法时，您需要设置 `enable` 参数为 `true`，并设置 `streamType` 为 `kNERtcVideoStreamTypeMain`（主流） 或 `kNERtcVideoStreamTypeSub`（辅流）。
    ::: note note
    自定义外部视频采集接口支持在通话过程中动态调用，接口设置在通话结束后仍然有效；若您需要关闭该功能，请在下次通话前再次调用此方法关闭自定义视频采集。
    :::
3. 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc.html#ad5c6e217dacfc20546617d98e3b5ba9b" target="_blank">`enableLocalVideo`</a> 方法开启媒体传输通道；调用此方法时，您需要设置 `enable` 参数为 `true`，并设置 `streamType` 为 `kNERtcVideoStreamTypeMain`（主流） 或 `kNERtcVideoStreamTypeSub`（辅流）。
    ::: note notice
    若您开启的是外部视频主流输入，请开启对应的媒体主流传输通道，辅流同理。
    :::
4. 您需要自行处理视频数据的采集与编码。
5. 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#a6838f1da1f06d06a7e17164e9be60387" target="_blank">`pushExternalVideoEncodedFrame`</a> 方法推送外部视频主流或辅流编码帧，并通过 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1video_1_1_n_e_rtc_video_encoded_frame.html" target="_blank">`NERtcVideoEncodedFrame`</a> 设置编码后的音频数据，包括视频编码器类型、NAL 帧数据类型、NAL 帧数据长度、视频帧宽高等。
    ::: note notice
    - 建议在推送外部视频编码帧时，不要同时调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#a17b9103fc32185304dd742663620c2d5" target="_blank">`pushExternalVideoFrame`</a> 方法。
    - 所有 NAL 帧数据长度之和不能超过 `nalData` 参数对应的数据总长度。
    :::
6. 推送视频编码帧成功后，您可以通过 [`setVideoEncoderQosObserver`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#a1f2a45aba16f257292018b10e70b033d) 接口注册视频编码 QoS 信息监听器，通过返回的相关视频编码数据调整视频编码策略。相关回调如下：
    - [`onRequestSendKeyFrame`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1video_1_1_n_e_rtc_video_encoder_qos_observer.html#a5a76bffbea1223336712ae89da38c12c)：I 帧请求事件回调。
    - [`onVideoCodecUpdated`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1video_1_1_n_e_rtc_video_encoder_qos_observer.html#aeb91f0ae2d07a9603b822e66d1bcfb21)：视频编码器类型信息回调。
    - [`onBitrateUpdated`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1video_1_1_n_e_rtc_video_encoder_qos_observer.html#a7e865ad0746d5dd744075d6cd458b56f)：视频码率信息回调。
    
### 示例代码

以实现视频主流编码帧传输为例，示例代码如下：

```
//设置视频流模式为单流
NERtcEx.getInstance().setVideoStreamLayerCount(kNERtcVideoStreamLayerCountOne);
//开启外部视频输入
NERtcVideoStreamType streamType; //视频流类型，主流或辅流
NERtcEx.getInstance().setExternalVideoSource(streamType, true);

//打开本地视频
NERtcEx.getInstance().enableLocalVideo(true);

//在qosObserver中实现如下回调，做相应的处理
private NERtcVideoEncoderQosObserver encoderQosObserver = new NERtcVideoEncoderQosObserver() {
    /**
     * I 帧请求，收到此回调，如果是外部编码，请及时发送相应IDR 帧
     *
     * @param videoStreamType 视频类型
     */
    @Override
    public void onRequestSendKeyFrame(NERtcVideoStreamType videoStreamType) {

    }

    /**
     * 码率信息
     *
     * @param bitrateBps      码率：kbps
     * @param videoStreamType 视频类型
     */
    @Override
    public void onBitrateUpdated(int bitrateBps, NERtcVideoStreamType videoStreamType) {

    }

    /**
     * 视频编码器类型信息回调，发布视频后会默认回调一次，后续如果编码器类型发生变更时就会回调。
     * @note
     * - 在视频编码器类型发生变更后，如果是外部编码，此时需要重置你的编码器。
     *
     * @param videoCodecType  编码器类型
     * @param videoStreamType 视频类型
     */
    @Override
    public void onVideoCodecUpdated(NERtcVideoCodecType videoCodecType, NERtcVideoStreamType videoStreamType) {

    }
};
//设置qos回调observer
NERtcEx.getInstance().setVideoEncoderQosObserver(encoderQosObserver);

//加入房间成功后再进行如下发送
NERtcVideoEncodedFrame frame = new NERtcVideoEncodedFrame();
frame.frameType = 帧类型;
frame.width = 视频宽;
frame.height = 视频高;
frame.codecType = 视频编码类型;
frame.timestampUs = 时间戳;
frame.nalData = 帧数据;
frame.nalLengths = 帧数据长度数组;
NERtcEx.getInstance().pushExternalVideoEncodedFrame(streamType, frame);
```

## 接收视频裸流

### 实现方法

1. 在初始化前，调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc.html#a7a9135f32ad0e10feb536944fd5a8ab2" target="_blank">`setParameters`</a> 方法关闭 NERTC SDK 的视频解码功能，SDK 将不会自动解码并渲染远端视频。

2. 在初始化后，调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#a601f459db392590ba0edea86376a356b" target="_blank">`setPreDecodeObserver`</a> 注册解码前媒体数据观测器。

3. 远端发送音频流后，SDK 触发 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1predecoder_1_1_n_e_rtc_pre_decode_observer.html#a91a24226449d5e6ebb8434b0ad54c9a4" target="_blank">`onFrame`</a> 回调，通过 <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1predecoder_1_1_n_e_rtc_pre_decode_frame_info.html" target="_blank">`preDecodeFrame`</a> 参数返回相关解码前媒体数据，包括用户的 UID、媒体数据类型、数据长度、视频帧宽高等。

4. 您需要自行处理视频数据的解码与渲染。

### 示例代码

```
//在observer中实现以下回调方法，处理接收到的视频裸流数据
NERtcPreDecodeObserver rtcPreDecodeObserver = new NERtcPreDecodeObserver() {
    /**
     * 解码前媒体数据回调
     * @param preDecodeFrame 解码前媒体数据
     */
    @Override
    public void onFrame(NERtcPreDecodeFrameInfo preDecodeFrame) {

    }
};
 //设置裸流接收回调observer
NERtcEx.getInstance().setPreDecodeObserver(rtcPreDecodeObserver);
```

## API 参考

| **方法** | **功能描述**|
|:--|:--|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#a95c76b8256518dbbadd8bd6a50c422c1" target="_blank">`setVideoStreamLayerCount`</a> |设置视频流的模式|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#a0b6f78498f4dfa59697af30679130f02" target="_blank">`setExternalVideoSource`</a> |开启外部视频源数据输入|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#a6838f1da1f06d06a7e17164e9be60387" target="_blank">`pushExternalVideoEncodedFrame`</a> |推送外部视频主流或辅流编码帧|
|[`setVideoEncoderQosObserver`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#a1f2a45aba16f257292018b10e70b033d) | 注册视频编码 QoS 信息监听器|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#a601f459db392590ba0edea86376a356b" target="_blank">`setPreDecodeObserver`</a>|注册解码前媒体数据观测器|

| **事件** | **事件描述** |
|:--|:--|
|[`onRequestSendKeyFrame`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1video_1_1_n_e_rtc_video_encoder_qos_observer.html#a5a76bffbea1223336712ae89da38c12c)|I 帧请求事件回调|
|[`onVideoCodecUpdated`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1video_1_1_n_e_rtc_video_encoder_qos_observer.html#aeb91f0ae2d07a9603b822e66d1bcfb21)|视频编码器类型信息回调|
|[`onBitrateUpdated`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1video_1_1_n_e_rtc_video_encoder_qos_observer.html#a7e865ad0746d5dd744075d6cd458b56f)|视频码率信息回调|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1predecoder_1_1_n_e_rtc_pre_decode_observer.html#a91a24226449d5e6ebb8434b0ad54c9a4" target="_blank">`onFrame`</a>|解码前媒体数据回调|