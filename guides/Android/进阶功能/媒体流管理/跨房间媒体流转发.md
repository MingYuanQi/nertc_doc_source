
在 NERTC 直播场景的音视频房间中，跨房间媒体流转发功能可实现主播角色跨房间与其他主播实时交流互动，在娱乐场景下可实现跨直播间连麦效果。本文档为您介绍跨房间媒体流转发的实现方法。
直播场景中，主播角色的媒体流可以同时转发到多个房间中，实现主播跨房间与其他主播实时互动的场景。该功能称为跨房间媒体流转发，在娱乐场景下可实现跨直播间连麦、在线教育场景下可实现超级小班课场景。

跨房间媒体流转发成功后，源房间中的主播发布的媒体流会同步到其他指定房间中，房间中的所有主播都可以进行实时音视频互动，房间中的观众角色也可以接收到所有主播的音视频流。

## 注意事项
- 该功能支持将媒体流转发至其他目标房间中，一个房间中可以有多个主播角色转发本人的媒体流。
- 只有直播场景下的主播角色可以调用 [`startChannelMediaRelay`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#aab6a2600bd3799a6a500610989f61c5a) 方法将本人的媒体流转发至其他房间中，否则会报错 kNERtcErrChannelMediaRelayPermissionDenied（30111）。
- 在成功调用 [`startChannelMediaRelay`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#aab6a2600bd3799a6a500610989f61c5a) 方法、开始跨房间转发媒体流后：
    - 如果想调整目标房间，例如添加或删除目标房间，可以调用 [`updateChannelMediaRelay`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#ae4f5b5827d6b23fe062d2b4726934844) 方法实现。
    - 如果想再次调用该方法，必须先调用 [`stopChannelMediaRelay`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#aefe628b0f3b1aac7b9f9f61ee0c502c1) 方法退出当前的转发状态。

## 实现方法
NERTC SDK 自 V4.2.1 版本开始支持跨房间媒体流转发功能，可以实现跨直播间连麦。

### API 时序

![](https://yx-web-nosdn.netease.im/quickhtml%2Fassets%2Fyunxin%2Fdoc%2FG2-ChannelMediaRelay-Android02.jpg)

### 实现步骤

1. 主播角色加入直播场景的房间之后，通过 [`startChannelMediaRelay`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#aab6a2600bd3799a6a500610989f61c5a) 开启跨直播间媒体流转发。
    - 此时需要通过参数 config 配置源房间、目标房间等信息。
    - 一个房间中可以有多个主播转发媒体流，需要跨房间连麦的主播可以在加入房间后随时调用此方法，此时 SDK 会转发该主播的媒体流，包括音频流、视频流与屏幕共享流等。
2. 在跨房间媒体流转发的过程中，如果需要调整目标房间，例如添加或删除目标房间，可以调用 [`updateChannelMediaRelay`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#ae4f5b5827d6b23fe062d2b4726934844) 方法实现。
    
    您可以在调用该方法之前，通过 [`ChannelMediaRelayConfiguration`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_media_relay_param_1_1_channel_media_relay_configuration.html) 中的 [`removeDestChannelInfo`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_media_relay_param_1_1_channel_media_relay_configuration.html#a606b9dbe7ddfe43c882f6d0cc9f382a6) 方法移除不需要的房间，再添加新的目标房间。
3. 在跨房间媒体流转发过程中，SDK 会通过 [`onMediaRelayStatesChange`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_callback_ex.html#a50b06dedbdb5840f45ba02803773f1f8) 和 [`onMediaRelayReceiveEvent`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_callback_ex.html#a50b06dedbdb5840f45ba02803773f1f8) 回调报告媒体流转发的状态和事件。
4. 主播离开房间时，跨房间媒体流转发自动停止，您也可以在需要的时候随时调用 [`stopChannelMediaRelay`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#aefe628b0f3b1aac7b9f9f61ee0c502c1) 方法，此时主播会退出所有目标房间。

## 示例代码

```
//初始化目标房间结构体
private NERtcMediaRelayParam.ChannelMediaRelayConfiguration addRelayConfig =  new NERtcMediaRelayParam.ChannelMediaRelayConfiguration();
//设置目标房间1
NERtcMediaRelayParam.ChannelMediaRelayInfo dstInfoA = new NERtcMediaRelayParam.ChannelMediaRelayInfo(mToken, tmp1, mUid1);
addRelayConfig.setDestChannelInfo(tmp1, dstInfoA);
//设置目标房间2
NERtcMediaRelayParam.ChannelMediaRelayInfo dstInfoB = new NERtcMediaRelayParam.ChannelMediaRelayInfo(mToken, tmp2, mUid2);
addRelayConfig.setDestChannelInfo(tmp2, dstInfoB);
//开启转发
int nRet = NERtcEx.getInstance().startChannelMediaRelay(addRelayConfig);

//更新转发目标房间
private NERtcMediaRelayParam.ChannelMediaRelayConfiguration updateConfig =  new NERtcMediaRelayParam.ChannelMediaRelayConfiguration();
//设定更新目标房间
NERtcMediaRelayParam.ChannelMediaRelayInfo dstInfoC = new NERtcMediaRelayParam.ChannelMediaRelayInfo(mToken, tmp3, mUid3);
updateConfig.setDestChannelInfo(tmp3, dstInfoC);
//开启更新
int nRet = NERtcEx.getInstance().updateChannelMediaRelay(updRelayConfig);

//停止转发
int nRet = NERtcEx.getInstance().stopChannelMediaRelay();
```

