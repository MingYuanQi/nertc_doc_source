<!--keywords: 质量监测,质量数据回调,网络状态,统计数据 -->
在通话场景中，开发者经常需要了解当前通话的通话质量、设备状态等信息，监测通话的整体体验；也可将部分质量数据在 UI 层面展示给用户，使用户能够及时了解当前通话的整体质量。NERTC SDK 支持将关键的音视频状况、网络状况、设备状态的相关指标实时回调给 APP 应用层，应用层可以将收到的数据进行展示或统计。

例如，在进行多人连麦时，您可以展示用户的实时网络质量，如下图所示。

<img style="width:400px" src=" https://yx-web-nosdn.netease.im/common/bc9cb52f00e1948491c5666d6db5c5c0/网络显示.png " alt="文本">

## <span id="功能介绍">功能介绍</span>

NERTC SDK 提供注册质量监测观测器 [`NERtcStatsObserver`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html) 的接口与相关回调方法，支持在通话中实时同步并返回质量数据，包括上下行网络质量、本地通话统计信息、本地和远端的音视频流统计信息等。

## <span id="示例项目">示例项目</span>

网易云信提供 [MediaStats 示例项目源码](https://github.com/netease-im/Advanced-Video/tree/master/MediaStats/MediaStats-Android-Java)，您可以参考该源码实现通话中质量监测。

## <span id="实现方法">实现方法</span>

调用 [`setStatsObserver`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#ac4b889a0fda28a78d7546ea4a7855162) 方法注册质量观测器，主动设置相应回调，回调名称与返回的质量数据信息的对应关系如下表所示。

| 回调 | 统计信息 |
| -- | -- |
| <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html#a1fa715c7c89399ab1c022ab881d62043" target="_blank">`onNetworkQuality`</a> | [上下行网络质量同步](#上下行网络质量同步) |
| <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html#ae8e3b98c1ed098420ca24ca05246ee9b" target="_blank">`onRtcStats`</a> | [统计信息同步](#统计信息同步) |
| <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html#a863ad60c810a488e3bf0081f751c061d" target="_blank">`onLocalAudioStats`</a>、<a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html#a8653a1c70ebc5c899b68180a7704448f" target="_blank">`onRemoteAudioStats`</a> | [音频质量同步](#音频质量同步) |
| <a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html#a4f862eef4f83362c623bd8946ae259b9" target="_blank">`onLocalVideoStats`</a>、<a href="https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html#a20d617715d2fc6454ae989ad33e52c36" target="_blank">`onRemoteVideoStats`</a> | [视频质量同步](#视频质量同步) |

::: note note
若您需要关闭质量监测功能，再次调用此方法并传入 `null` 即可。
:::

**示例代码**如下：

```
//返回本地通话统计信息
NERtcEx.getInstance().setStatsObserver(new NERtcStatsObserver() {
    @Override
    public void onRtcStats(NERtcStats stats) {
        String statsStrInfo = String.format(Locale.CHINA, "tx:%.2fMB rx: %.2fMB v_lost:%d%% a_lost:%d%% upRtt:%d downRtt:%d",
                stats.txBytes / M_SIZE, stats.rxBytes / M_SIZE,
                stats.txVideoPacketLossRate, stats.txAudioPacketLossRate, stats.upRtt, stats.downRtt);
    }

    //返回本地设备发送音频流的统计信息
    @Override
    public void onLocalAudioStats(NERtcAudioSendStats stats) {
        for (NERtcAudioLayerSendStats layer : stats.audioLayers) {
            // 音频主流及音频辅流
            String statsStrInfo = String.format(Locale.CHINA, "audio_type:%d , kbps:%dKbps vol:%d cap_vol:%d lost:%d%% rtt:%d",
                    layer.streamType, layer.kbps, layer.volume, layer.capVolume, layer.lossRate, layer.rtt);
        }
    }

    //返回通话中每个远端用户音频流的统计信息
    @Override
    public void onRemoteAudioStats(NERtcAudioRecvStats[] statsArray) {
        if (statsArray == null) {
            return;
        }
        for (NERtcAudioRecvStats stats : statsArray) {
            for (NERtcAudioLayerRecvStats layer : stats.layers) {
                // 音频主流及音频辅流
                String statsStrInfo = String.format(Locale.CHINA, "audio_type:%d , kbps:%dKbps vol:%d lost:%d%%",
                        layer.streamType, layer.kbps, layer.volume, layer.lossRate);
            }
        }
    }


    //返回本地设备发送视频流的统计信息
    @Override
    public void onLocalVideoStats(NERtcVideoSendStats stats) {
        if (stats == null) {
            return;
        }

        for (NERtcVideoLayerSendStats sendStats : stats.videoLayers) {
            String statsStrInfo = String.format(Locale.CHINA, "video_type:%d cap_width:%d cap_height:%d send_width:%d send_height:%d  fps:%d enc_bitrate:%d kbps send_bitrate:%d kbps encoder:%s",
                    sendStats.layerType,
                    sendStats.capWidth,
                    sendStats.capHeight,
                    sendStats.width,
                    sendStats.height,
                    sendStats.encoderOutputFrameRate,
                    sendStats.encoderBitrate,
                    sendStats.sendBitrate,
                    sendStats.encoderName);
        }

    }

    //返回通话中每个远端用户视频流的统计信息
    @Override
    public void onRemoteVideoStats(NERtcVideoRecvStats[] statsArray) {
        if (statsArray == null) {
            return;
        }
        for (NERtcVideoRecvStats stats : statsArray) {
            for (NERtcVideoLayerRecvStats recvStats : stats.layers) {
                String statsStrInfo = String.format(Locale.CHINA, "video_type%d: width:%d height:%d fps:%d bitrate:%d kbps lost:%d%% decoder:%s",
                        recvStats.layerType,
                        recvStats.width,
                        recvStats.height,
                        recvStats.fps,
                        recvStats.receivedBitrate,
                        recvStats.packetLossRate,
                        recvStats.decoderName);
            }
        }
    }


    //返回通话中每个成员的上下行网络质量
    @Override
    public void onNetworkQuality(NERtcNetworkQualityInfo[] statsArray) {
        if (statsArray == null) {
            return;
        }
        for (NERtcNetworkQualityInfo info : statsArray) {
            String statsStrInfo = String.format(Locale.CHINA, "uid:%d up:%d down:%d", info.upStatus, info.upStatus, info.downStatus);
        }

    }
});
```
## 相关回调的详细说明
### <span id="上下行网络质量同步">上下行网络质量同步</span>

[**`onNetworkQuality`**](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html#a1fa715c7c89399ab1c022ab881d62043) 回调以数组的形式向您同步当前通话中每个成员的上下行网络质量。
- 上行网络质量打分基于实际发送码率、上行网络丢包率、平均往返时延和上行网络抖动计算。
- 下行网络质量打分基于下行网络丢包率、平均往返时延和下行网络抖动计算。

::: note note
- 每隔 2 秒您会收到房间内所有用户的网络质量同步。
- 实际发送码率与目标发送码率的比值越高，该网络下的通话质量越好，该网络质量打分越高。
:::

[**`NERtcNetworkQualityInfo`**](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_network_quality_info.html) 数组中各参数的说明如下表所示。

<table>
<tr>
    <th width="30%">参数</th>
    <th width="70%">参数说明</th>
</tr>
    <tr>
    <td>userId</td>
    <td>用户 ID，指定是哪个用户的网络质量统计。</td>
</tr>
    <tr>
    <td>upStatus</td>
    <td>该用户的上行网络质量。</td>
</tr>
    <tr>
    <td>downStatus</td>
    <td>该用户的下行网络质量。</td>
</tr>
</table>

其中网络质量以网络状态的好坏衡量，[**`NetworkStatus`**](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_constants_1_1_network_status.html) 的各枚举值如下表所示。

<table>
<tr>
    <th width="30%">枚举值</th>
    <th width="70%">说明</th>
</tr>
    <tr>
    <td>UNKNOWN（0）</td>
    <td>当前网络状态未知。</td>
</tr>
    <tr>
    <td>EXCELLENT（1）</td>
    <td>当前网络状态极好。</td>
</tr>
    <tr>
    <td>GOOD（2）</td>
    <td>当前网络状态不错。</td>
</tr>
    <tr>
    <td>POOR（3）</td>
    <td>当前网络状态一般。</td>
</tr>
    <tr>
    <td>BAD（4）</td>
    <td>当前网络状态比较差，可能出现卡顿和网络延迟。</td>
</tr>
    <tr>
    <td>VERYBAD（5）</td>
    <td>当前网络状态非常差，无法保证正常的通话质量。</td>
</tr>
    <tr>
    <td>DOWN（6）</td>
    <td>当前无网络。</td>
</tr>
</table>


### <span id="统计信息同步">统计信息同步</span>

[**`onRtcStats`**](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html#ae8e3b98c1ed098420ca24ca05246ee9b) 回调向您同步本地通话统计信息。其中包含通话时长、当前通话房间中的人数、当前系统的 CPU 使用率、当前 App 的 CPU 使用率等重要数据。

<table>
<tr>
    <th width="30%">参数</th>
    <th width="70%">参数说明</th>
</tr>
    <tr>
        <td>cpuAppUsage、cpuTotalUsage</td>
        <td>App 的 CPU 使用率和系统的 CPU 使用率。</td>
    </tr>
    <tr>
        <td>memoryAppUsageRatio、memoryAppUsageInKBytes、memoryTotalUsageRatio</td>
        <td>App 的内存使用率、内存使用量、系统的内存使用率。</td>
    </tr>
    <tr>
        <td>totalDuration</td>
        <td>通话总时长，单位为秒。</td>
    </tr>
    <tr>
        <td>txBytes/rxBytes</td>
        <td>累计发送/接收字节数。</td>
    </tr>
    <tr>
        <td>txAudioBytes/rxAudioBytes</td>
        <td>音频发送/接收字节数。</td>
    </tr>
    <tr>
        <td>txVideoBytes/rxVideoBytes</td>
        <td>视频发送/接收字节数。</td>
    </tr>
    <tr>
        <td>txAudioKBitRate/rxAudioKBitRate</td>
        <td>音频接收/发送码率，单位为 Kbps。</td>
    </tr>
    <tr>
        <td>txVideoKBitRate/rxVideoKBitRate</td>
        <td>视频接收/发送码率，单位为 Kbps。</td>
    </tr>
    <tr>
        <td>upRtt/downRtt</td>
        <td>上行/下行平均往返时延，单位为毫秒。</td>
    </tr>
    <tr>
        <td>txAudioPacketLossRate/rxAudioPacketLossRate</td>
        <td>本地上行/下行音频实际丢包率。</td>
    </tr>
    <tr>
        <td>txAudioPacketLossSum/rxAudioPacketLossSum</td>
        <td>本地上行/下行音频实际丢包数。</td>
    </tr>
    <tr>
        <td>txAudioJitter/rxAudioJitter</td>
        <td>本地上行/下行音频抖动计算，单位为毫秒。</td>
    </tr>
    <tr>
        <td>txVideoJitter/rxVideoJitter</td>
        <td>本地上行/下行视频抖动计算，单位为毫秒。</td>
    </tr>
    <tr>
        <td>txVideoPacketLossRate/rxVideoPacketLossRate</td>
        <td>本地上行/下行视频实际丢包率。</td>
    </tr>
    <tr>
        <td>txVideoPacketLossSum/rxVideoPacketLossSum</td>
        <td>本地上行/下行视频实际丢包数。</td>
    </tr>
</table>

### <span id="音频质量同步">音频质量同步</span>

**本地音频流统计信息同步**

[**`onLocalAudioStats`**](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html#a863ad60c810a488e3bf0081f751c061d) 回调向您同步本地设备发送音频流的统计信息，包括当前通话声道数（单声道或双声道）、发送音频的采样率和发送音频的码率。SDK 会每隔 2 秒自动触发本回调。

<table>
    <tr>
        <th width="20%"><b>参数</b></th>
        <th width="40%"><b>参数说明</b></th>
    </tr>
    <tr>
        <td>numChannels</td>
        <td>当前采集的声道数。</td>
    </tr>
    <tr>
        <td>sentSampleRate</td>
        <td>统计周期内本地上行音频采样率，单位为 Hz。</td>
    </tr>
    <tr>
        <td>kbps</td>
        <td>统计周期内发送码率的平均值，单位为 Kbps。</td>
    </tr>
    <tr>
        <td>lossRate</td>
        <td>特定时间内的音频丢包率。</td>
    </tr>
    <tr>
        <td>rtt</td>
        <td>平均往返时延（RTT）。</td>
    </tr>
    <tr>
        <td>volume</td>
        <td>音量，取值范围为 0 ~ 100。</td>
    </tr>
</table>

**远端音频流统计信息同步**

[**`onRemoteAudioStats`**](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html#a8653a1c70ebc5c899b68180a7704448f) 回调向您同步当前通话中每个远端用户音频流的统计信息，包括每个远端用户发送的音频流质量、声道数等信息。SDK 会每隔 2 秒自动触发本回调。

<table>
    <tbody>
        <tr>
            <td width="20%"><strong>参数</strong></td>
            <td width="40%"><strong>参数说明</strong></td>
        </tr>
        <tr>
            <td>uid</td>
            <td>用户 ID，指定是哪个用户的音频流。</td>
        </tr>
        <tr>
            <td>kbps</td>
            <td>统计周期内接收到的码率平均值，单位为 Kbps。</td>
        </tr>
        <tr>
            <td>totalFrozenTime</td>
            <td>远端用户在加入房间后发生音频卡顿的累计时长，单位为毫秒。一个统计周期内，音频丢帧率达到 4% 即记为一次音频卡顿。</td>
        </tr>
        <tr>
            <td>frozenRate</td>
            <td>远端用户下行音频平均卡顿率。其值为远端用户在加入房间后发生音频卡顿的累计时长占音频总有效时长的百分比。</td>
        </tr>
        <tr>
            <td>lossRate</td>
            <td>统计周期内的远端音频流的丢帧率。</td>
        </tr>
        <tr>
            <td>volume</td>
            <td>音量，取值范围为 0 ~ 100。</td>
        </tr>
    </tbody>
</table>

### <span id="视频质量同步">视频质量同步</span>

**本地视频流统计信息同步**

[**`onLocalVideoStats`**](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html#a4f862eef4f83362c623bd8946ae259b9) 回调向您同步本地设备发送视频流的统计信息，包括视频编码宽/高等信息。SDK 会每隔 2 秒自动触发本回调。

如果您此前调用 [`enableDualStreamMode`](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/classcom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1_n_e_rtc_ex.html#ac9ee4b883d6cdecc2990a43527f8be86) 方法开启了双流模式，则本回调描述本地设备发送的视频大流的统计信息。

<table>
    <tbody>
        <tr>
            <td width="20%"><strong>参数</strong></td>
            <td width="40%"><strong>参数说明</strong></td>
        </tr>
        <tr>
            <td>layerType</td>
            <td>视频流通道类型。<li>1：主流。<li>2：辅流。</td>
        </tr>
        <tr>
            <td>width</td>
            <td>视频编码宽度，单位为 px。</td>
        </tr>
        <tr>
            <td>height</td>
            <td>视频编码高度，单位为 px。</td>
        </tr>
        <tr>
            <td>captureFrameRate</td>
            <td>视频采集帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>renderFrameRate</td>
            <td>视频渲染帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>encoderOutputFrameRate</td>
            <td>编码帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>sentFrameRate</td>
            <td>实际发送帧率，单位为 fps，不包含丢包后重传视频等的发送帧率。</td>
        </tr>
        <tr>
            <td>sendBitrate</td>
            <td>实际发送码率，单位为 Kbps，不包含丢包后重传视频等的发送码率。</td>
        </tr>
        <tr>
            <td>targetBitrate</td>
            <td>当前编码器的目标编码码率，单位为 Kbps，该码率为 SDK 根据当前网络状况预估的一个值。</td>
        </tr>
        <tr>
            <td>encoderBitrate</td>
            <td>编码器实际编码码率，单位为 Kbps。</td>
        </tr>
        <tr>
            <td>encoderName</td>
            <td>视频编码器的名称。</td>
        </tr>
    </tbody>
</table>

**远端视频流统计信息同步**

[**`onRemoteVideoStats`**](https://doc.yunxin.163.com/nertc/api-refer/android/doxygen/Latest/zh/html/interfacecom_1_1netease_1_1lava_1_1nertc_1_1sdk_1_1stats_1_1_n_e_rtc_stats_observer.html#a20d617715d2fc6454ae989ad33e52c36) 回调向您同步当前通话中每个远端用户/主播的视频流的统计信息，包括每个远端用户的视频宽/高等参数信息。SDK 会每隔 2 秒自动触发本回调。

<table>
    <tbody>
        <tr>
            <td width="20%"><strong>参数</strong></td>
            <td width="40%"><strong>参数说明</strong></td>
        </tr>
        <tr>
            <td>layerType</td>
            <td>视频流通道类型。<li>1：主流。<li>2：辅流。</td>
        </tr>
        <tr>
            <td>width</td>
            <td>远端视频编码宽度，单位为 px。</td>
        </tr>
        <tr>
            <td>height</td>
            <td>远端视频编码高度，单位为 px。</td>
        </tr>
        <tr>
            <td>receivedBitrate</td>
            <td>接收到的码率，单位为 Kbps。</td>
        </tr>
        <tr>
            <td>fps</td>
            <td>接收到的帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>decoderOutputFrameRate</td>
            <td>解码帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>rendererOutputFrameRate</td>
            <td>渲染帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>packetLossRate</td>
            <td>远端视频下行丢包率。</td>
        </tr>
        <tr>
            <td>totalFrozenTime</td>
            <td>远端用户加入房间后，其下行视频卡顿累计时长，单位为毫秒。</td>
        </tr>
        <tr>
            <td>frozenRate</td>
            <td>远端用户加入房间后，其下行视频平均卡顿率，其值为视频卡顿的累计时长占视频总有效时长的百分比。</td>
        </tr>
        <tr>
            <td>decoderName</td>
            <td>视频编码器的名称。</td>
        </tr>
    </tbody>
</table>
