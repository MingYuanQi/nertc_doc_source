<!--- keywords:实时音视频,原始音频数据,前处理,后处理 -->

NERTC SDK 的音频模块会严格控制声音设备的采集和播放逻辑，同时支持对采集到的音视频原始数据进行自定义的前处理和后处理，获取想要的播放效果。适用于非标设备接入、自定义音频效果、语音处理、语音识别等场景。

- 前处理：在音频数据发送到编码器前获取原始的音频数据进行修改，主要针对本地麦克风采集到的音频数据或自定义外部音频流。
- 后处理：即在音频数据发送给解码器后获取原始的音频数据进行修改，主要针对接收到的远端用户音频数据。

NERTC SDK 通过提供 `NERtcAudioFrameObserver` 类，实现采集、修改原始音频数据功能。

## 前提条件

在使用原始数据处理功能前，请确保您已在项目中实现基本的实时音视频功能。

## <span id="iOS注意事项">注意事项</span>

- 采集回调 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#a5dfe952459d840f86eb3851bf95666e0" target="_blank">`onNERtcEngineAudioFrameDidRecord`</a>、播放回调 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#a6de538aa534820f67b002ed1e8a84dc6" target="_blank">`onNERtcEngineAudioFrameWillPlayback`</a> 中的原始音频数据可进行处理，例如美声变声。
- 混音回调 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#aebbdb9feccf532c3bd8d464ba268ad6a" target="_blank">`onNERtcEngineMixedAudioFrame`</a> 和某一用户的播放回调 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#a6e70fb2a067194a64c830bcc23b1d994" target="_blank">`onNERtcEnginePlaybackAudioFrameBeforeMixingWithUserID`</a> 中的原始音频数据不能进行处理。

## 技术原理

![rawdata.png](https://yx-web-nosdn.netease.im/common/97f580b8356c1a56c7c7b5f415864e20/rawdata.png)

## <span id="iOS实现方法">实现方法</span>

### **API 调用时序**

以实现修改采集音频的音频数据为例，API 调用时序如下图所示。

  ```mermaid
  sequenceDiagram
      autonumber
      participant 应用层
      participant NERtcSDK

      
      应用层->>NERtcSDK: setAudioFrameObserver
      应用层->>NERtcSDK: setRecordingAudioFrameParameters
      NERtcSDK-->>应用层: onNERtcEngineAudioFrameDidRecord
      Note over 应用层, NERtcSDK: 自行处理音频数据
      NERtcSDK-->>应用层: onNERtcEngineAudioFrameDidRecord

  ```
  


### **配置步骤**

1. 加入房间前调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#abcb3c336144da3aeedd4309501cff73c" target="_blank">`setAudioFrameObserver`</a> 方法注册语音观测器，并在该方法中实现一个 `NERtcEngineAudioFrameObserver` 类。

2. 设置回调的音频采样率。
    - 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#aeea413208d7c250a1f700dd5f85c5904" target="_blank">`setRecordingAudioFrameParameters`</a> 方法修改回调的采集音频采样率，并将回调的音频数据设置为只读模式或读写模式。
    - 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#a8a7e9a66f2938e8f1fe8d941bbc5869e" target="_blank">`setPlaybackAudioFrameParameters`</a> 方法修改回调的播放音频采样率，并将回调的音频数据设置为只读模式或读写模式。
    - 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#ab10bdab05e8f954c5fa25cc3920f6f93" target="_blank">`setMixedAudioFrameParameters`</a> 方法，设置 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#aebbdb9feccf532c3bd8d464ba268ad6a" target="_blank">`onNERtcEngineMixedAudioFrame`</a> 回调中的混音音频采样率。

3. SDK 返回回调。
    - SDK 收到输入的采集数据和播放的音频数据时，返回 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#a5dfe952459d840f86eb3851bf95666e0" target="_blank">`onNERtcEngineAudioFrameDidRecord`</a> 和 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#a6de538aa534820f67b002ed1e8a84dc6" target="_blank">`onNERtcEngineAudioFrameWillPlayback`</a> 回调。
    - SDK 收到音频采集与播放混合后数据帧时，返回 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#aebbdb9feccf532c3bd8d464ba268ad6a" target="_blank">`onNERtcEngineMixedAudioFrame`</a> 回调；SDK 收到某一远端用户播放的音频数据时，返回 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#a6e70fb2a067194a64c830bcc23b1d994" target="_blank">`onNERtcEnginePlaybackAudioFrameBeforeMixingWithUserID`</a> 回调。

4. 用户拿到音频数据后，需要根据场景自行进行处理。

5. 完成音频数据处理后，您可以直接进行自播放，或根据场景需求再通过 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#a5dfe952459d840f86eb3851bf95666e0" target="_blank">`onNERtcEngineAudioFrameDidRecord`</a> 和 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#a6de538aa534820f67b002ed1e8a84dc6" target="_blank">`onNERtcEngineAudioFrameWillPlayback`</a> 回调发送给 SDK。

### <span id="iOS示例代码">**示例代码**</span>

```objc
//1. 注册语音观测器
 [[NERtcEngine sharedEngine] setAudioFrameObserver:self];

//2.设置回调的音频格式参数
  NERtcAudioFrameRequestFormat *format = [[NERtcAudioFrameRequestFormat alloc] init];
  format.channels = 1;
  format.sampleRate = 48000;
  format.mode = kNERtcAudioFrameOpModeReadWrite; //读写模式
  [[NERtcEngine sharedEngine] setRecordingAudioFrameParameters:format];

//3.在回调中处理数据
- (void)onNERtcEngineAudioFrameDidRecord:(NERtcAudioFrame *)frame {
    if (!frame) {
        return;
    }

    if (!_enableRecordAudioObserver) {
        return;
    }

    if (!_recordSoundTouch) {
        _recordSoundTouch = [[NTESSoundTouch alloc] initWithSampleRate:frame.format.sample_rate];
    }

    //若读写模式，SDK将会对处理后的音频数据发送，反之不会。
    [_recordSoundTouch processSound:frame.data number:frame.format.samples_per_channel];
}

- (void)onNERtcEngineAudioFrameWillPlayback:(NERtcAudioFrame *)frame {
    if (!frame) {
        return;
    }

    if (!_enablePlaybackAudioObserver) {
        return;
    }

    if (!_playbackSoundTouch) {
        _playbackSoundTouch = [[NTESSoundTouch alloc] initWithSampleRate:frame.format.sample_rate];
    }
  
    //若读写模式，SDK将会对处理后的音频数据发送，反之不会。
    [_playbackSoundTouch processSound:frame.data number:frame.format.samples_per_channel];
}
```

## API 参考
| **方法** | **功能描述**|
|:--|:--|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#aeea413208d7c250a1f700dd5f85c5904" target="_blank">`setRecordingAudioFrameParameters`</a>|设置回调的采集音频采样率|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#a8a7e9a66f2938e8f1fe8d941bbc5869e" target="_blank">`setPlaybackAudioFrameParameters`</a>|设置回调的播放音频采样率|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#ab10bdab05e8f954c5fa25cc3920f6f93" target="_blank">`setMixedAudioFrameParameters`</a> |设置回调的混音音频采样率|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#abcb3c336144da3aeedd4309501cff73c" target="_blank">`setAudioFrameObserver`</a>|注册语音观测器|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#a5dfe952459d840f86eb3851bf95666e0" target="_blank">`onNERtcEngineAudioFrameDidRecord`</a>| 接收本端输入的采集音频数据回调|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#a6de538aa534820f67b002ed1e8a84dc6" target="_blank">`onNERtcEngineAudioFrameWillPlayback`</a>|接收本端输入的播放音频数据播放回调|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#aebbdb9feccf532c3bd8d464ba268ad6a" target="_blank">`onNERtcEngineMixedAudioFrame`</a>|接收采集与播放音频混合数据帧回调|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_audio_frame_observer-p.html#a6e70fb2a067194a64c830bcc23b1d994" target="_blank">`onNERtcEnginePlaybackAudioFrameBeforeMixingWithUserID`</a>|接收远端播放的音频数据帧回调|