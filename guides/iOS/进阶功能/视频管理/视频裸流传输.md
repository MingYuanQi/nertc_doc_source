<!--keywords:音视频通话,纯传输通道,编码后数据传输,裸流传输 -->

在一些需要与硬件配合的应用场景中，比如使用教室硬件设备进行线上教学，在利用硬件自身能力进行视频采集、编码的基础上，还需要良好的抗弱网传输能力。若您拥有第三方视频编解码模块或有能力自研编解码，为了实现实时视频码流传输互通，NERTC SDK 为您提供抗弱网、抗丢包的纯传输通道。

## 功能介绍

依托网易云信底层实时传输网络 WE-CAN（Communication Acceleration Network），NERTC 运用全球节点及抗弱网算法，提供低延时、高稳定性的音视频码流传输通道，大大减少延时、丢包等网络问题对音视频传输质量和体验的影响。

NERTC SDK 支持视频裸流传输，您可以向 NERTC SDK 提供自定义的 H.264 等格式的视频编码数据，并由 NERTC SDK 进行推流。

## 注意事项

使用 NERTC SDK 提供的裸流传输通道时，您需要自行管理视频流的采集、编解码、渲染和其他处理。

## 发送视频裸流

### 实现方法

1. 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#a3c4e5a4f47654867fffbc11530b5853e" target="_blank">`setVideoStreamLayerCount`</a> 方法设置视频流的模式；调用此方法时，您需要设置 `layerCount` 参数为 `kNERtcVideoStreamLayerCountOne`，开启单流模式。
2. 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#abec9a0d2e9018b2c5feee77eda3c54b6" target="_blank">`setExternalVideoSource`</a> 方法开启外部视频源数据输入；调用此方法时，您需要设置 `enable` 参数为 `true`，并设置 `streamType` 为 `kNERtcStreamChannelTypeMainStream`（主流） 或 `kNERtcStreamChannelTypeSubStream`（辅流）。
    ::: note note
    - 自定义外部视频采集接口支持在通话过程中动态调用，接口设置在通话结束后仍然有效；若您需要关闭该功能，请在下次通话前再次调用此方法关闭自定义视频采集。
    - 暂不支持**同时开启**视频主、辅流通道推送外部视频编码帧数据。
    :::
3. 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine-p.html#a9f13beb56a8b9fdfbc856d304c0d10cb" target="_blank">`enableLocalVideo`</a> 方法开启本地视频采集；调用此方法时，您需要设置 `enable` 参数为 `true`，并设置 `streamType` 为 `kNERtcStreamChannelTypeMainStream`（主流） 或 `kNERtcStreamChannelTypeSubStream`（辅流）。
    ::: note notice
    若您开启的是外部视频主流输入，请开启对应的媒体主流传输通道，辅流同理。
    :::
4. 您需要自行处理视频数据的采集与编码。
5. 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#a5d7a5747cf65f8b3e460615eb1ef6802" target="_blank">`pushExternalVideoEncodedFrame`</a> 方法推送外部视频主流编码帧或调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#a255026994590662f19e079a0446c6292" target="_blank">`pushExternalSubStreamVideoEncodedFrame`</a> 方法推送外部视频辅流编码帧，并通过 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/interface_n_e_rtc_video_encoded_frame.html" target="_blank">`NERtcVideoEncodedFrame`</a> 设置编码后的音频数据，包括视频编码器类型、NAL 帧数据类型、NAL 帧数据长度、视频帧宽高等。
    ::: note notice
    - 建议在推送外部视频编码帧时，不要同时调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#a66673915d07935534c6bac6fbc086f2a" target="_blank">`pushExternalVideoFrame`</a> 方法。
    - 所有 NAL 帧数据长度之和不能超过 `nalData` 参数对应的数据总长度。
    :::
6. 推送视频编码帧成功后，您可以通过 [`setVideoEncoderQosObserver`](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#ae3e54bf4917a95cc77d254fe71711d9e) 接口注册视频编码 QoS 信息监听器，通过返回的相关视频编码数据调整视频编码策略。相关回调如下：
    - [`onNERtcEngineRequestSendKeyFrame`](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_video_encoder_qos_observer-p.html#a3cd1e4e59088d538880d02ca776502e2)：I 帧请求事件回调。
    - [`onNERtcEngineVideoCodecUpdated`](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_video_encoder_qos_observer-p.html#a33a044eb41d9fba2f494c177bd74cafd)：视频编码器类型信息回调。
    - [`onNERtcEngineBitrateUpdated`](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_video_encoder_qos_observer-p.html#a57d24bfa909b4abeec9c7aaf347dcf17)：视频码率信息回调。

### 示例代码
以实现视频主流编码帧传输为例，示例代码如下：
```
//以实现发送视频主流编码后数据为例

//开启外部视频输入
[[NERtcEngine sharedEngine] setExternalVideoSource:YES isScreen:是否为主流视频];
//打开本地视频
[[NERtcEngine sharedEngine] enableLocalVideo:YES];
//设置qos回调observer
[[NERtcEngine sharedEngine] setVideoEncoderQosObserver:qosobserver];
  
//加入房间成功后再进行如下发送
//发送编码后视频裸流(以下代码为单帧数据输入示例，需要放在合适的编码数据数据的位置)
NERtcVideoEncodedFrame *frame = [[NERtcVideoEncodedFrame alloc] init];
frame.frameType = 帧类型;
frame.width = 视频宽;
frame.height = 视频高;
frame.codecType = 视频编码类型;
frame.timestampUs = 时间戳;
frame.nalData = 帧数据;
frame.nalLengths = 帧数据长度数组;
[[NERtcEngine sharedEngine] pushExternalVideoEncodedFrame:frame];

//在qosObserver中实现如下回调，做相应的处理
//I 帧请求，收到此回调，如果是外部编码，请及时发送相应IDR 帧
- (void)onNERtcEngineRequestSendKeyFrame:(NERtcStreamChannelType)videoStreamType {
}
//码率信息更新请求，需要更新编码码率
- (void)onNERtcEngineBitrateUpdated:(int)bitrateBps
                    videoStreamType:(NERtcStreamChannelType)videoStreamType {
}
//视频编码器类型信息回调，发布视频后会默认回调一次，后续如果编码器类型发生变更时就会回调。
- (void)onNERtcEngineVideoCodecUpdated:(NERtcVideoCodecType)videoCodecType
                       videoStreamType:(NERtcStreamChannelType)videoStreamType {
}
```

## 接收视频裸流

### 实现方法

1. 在初始化前，调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine-p.html#a2a674564c41bbd4b5556f08a9d65a558" target="_blank">`setParameters`</a> 方法关闭 NERTC SDK 的视频解码功能，SDK 将不会自动解码并渲染远端视频。

2. 在初始化后，调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#aa87ad6f859a3a768e58d56485a9c2278" target="_blank">`setPreDecodeObserver`</a> 注册解码前媒体数据观测器。

3. 远端发送音频流后，SDK 触发 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_pre_decode_observer-p.html#ae85207c411de174e47a7ee1214795056" target="_blank">`onNERtcEnginePreDecoderFrame`</a> 回调，通过 <a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/interface_n_e_rtc_pre_decoder_frame_info.html" target="_blank">`preDecodeFrame`</a> 参数返回相关解码前媒体数据，包括用户的 UID、媒体数据类型、数据长度、视频帧宽高等。

4. 您需要自行处理视频数据的解码与渲染。

### 示例代码

```
//设置裸流接收回调observer
[[NERtcEngine sharedEngine] setPreDecodeObserver:observer];
//在observer中实现以下回调方法，处理接收到的视频裸流数据
- (void)onNERtcEnginePreDecoderFrame:(NERtcPreDecoderFrameInfo *)preDecoderFrame {
}
```

## API 参考

| **方法** | **功能描述**|
|:--|:--|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#a3c4e5a4f47654867fffbc11530b5853e" target="_blank">`setExternalVideoSource`</a> |设置视频流的模式|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#abec9a0d2e9018b2c5feee77eda3c54b6" target="_blank">`setExternalVideoSource`</a> |开启外部视频源数据输入|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine-p.html#a9f13beb56a8b9fdfbc856d304c0d10cb" target="_blank">`enableLocalVideo`</a> |开启本地视频|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#a5d7a5747cf65f8b3e460615eb1ef6802" target="_blank">`pushExternalVideoEncodedFrame`</a> |推送外部视频主流编码帧|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#a255026994590662f19e079a0446c6292" target="_blank">`pushExternalSubStreamVideoEncodedFrame`</a>|推送外部视频辅流编码帧|
|[`setVideoEncoderQosObserver`](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#ae3e54bf4917a95cc77d254fe71711d9e) | 注册视频编码 QoS 信息监听器|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_i_n_e_rtc_engine_ex-p.html#aa87ad6f859a3a768e58d56485a9c2278" target="_blank">`setPreDecodeObserver`</a>| 注册解码前媒体数据观测器|


| **事件** | **事件描述** |
|:--|:--|
|[`onNERtcEngineRequestSendKeyFrame`](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_video_encoder_qos_observer-p.html#a3cd1e4e59088d538880d02ca776502e2)| I 帧请求事件回调|
|[`onNERtcEngineVideoCodecUpdated`](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_video_encoder_qos_observer-p.html#a33a044eb41d9fba2f494c177bd74cafd)| 视频编码器类型信息回调|
| [`onNERtcEngineBitrateUpdated`](https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_video_encoder_qos_observer-p.html#a57d24bfa909b4abeec9c7aaf347dcf17)|视频码率信息回调|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/iOS/doxygen/Latest/zh/html/protocol_n_e_rtc_engine_pre_decode_observer-p.html#ae85207c411de174e47a7ee1214795056" target="_blank">`onNERtcEnginePreDecoderFrame`</a>|解码前媒体数据回调|