<!--keywords:音视频通话,美颜,相芯,Faceunity Nama-->
网易云信 NERTC SDK 支持接入相芯等第三方专业美颜滤镜厂商，实现美颜、美妆、滤镜、贴纸等美颜特效。在娱乐社交、在线教育等场景中，您可以快速构建具备美颜特效能力的应用，让用户在进行视频通话或直播时，呈现更良好的肌肤状态和精神面貌。

相芯美颜（Faceunity Nama SDK，下文简称 Nama SDK）的详细功能介绍请参考 <a href="https://yunxin.163.com/face" target="_blank">人脸特效</a>。

<style>
table th:first-of-type {
    width: 35%;
}
</style>

## 准备工作

根据本文操作前，请确保您已经完成了以下设置：

1. [下载相芯美颜 SDK](https://github.com/Faceunity/FULiveDemoDroid/releases)。
2. 获取相芯美颜 SDK 的证书，具体请联系网易云信商务经理。
3. 获取相芯美颜资源文件，具体请联系网易云信商务经理。

## 功能原理

<img alt="相芯美颜原理.png" src="https://yx-web-nosdn.netease.im/common/4989bbdcd8c7537e65727a3a517445bc/相芯美颜原理.png" style="width:50%;border: 1px solid #BFBFBF;">

1. NERTC SDK 提供了 <a href="https://doc.yunxin.163.com/nertc/references/windows/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine_event_handler_ex.html#ad0423dae090d924f82a8765bacca3365" target="_blank">`onCaptureVideoFrame`</a> 采集数据回调的接口，将采集到的视频图像数据通过该接口回调出来。

2. Nama SDK 通过回调获取视频图像数据，进行美颜处理后，通过参数返回给 NERTC SDK。

3. NERTC SDK 将美颜后的数据进行编码和传输。

## <span id="注意事项">注意事项</span>

- 该设置仅在加入房间之前设置才有效。

- <a href="https://doc.yunxin.163.com/nertc/references/macOS/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine_event_handler_ex.html#ad0423dae090d924f82a8765bacca3365" target="_blank">`onCaptureVideoFrame`</a> 回调必须同步返回，且保证 data 的地址值不被改变，分辨率不改变。

## 示例项目源码

网易云信提供 [第三方美颜的示例项目源码](https://github.com/netease-im/Advanced-Video/tree/master/Beauty)，您可以参考该源码实现第三方美颜。

## 第一步：集成相芯美颜

1. 将证书文件 `authpack.h` 放到本地项目的 `Beauty` 目录下。

2. 将所需的美颜模型和道具放到本地项目的 `Resource` 目录下。
3. 集成相芯美颜 SDK，具体步骤请参考 [Faceunity Nama 相关文档](https://github.com/Faceunity/FULivePC/blob/master/docs/Windows_Nama_SDK_%E9%9B%86%E6%88%90%E6%8C%87%E5%AF%BC%E6%96%87%E6%A1%A3.md)。

## 第二步：初始化相芯美颜 SDK

具体步骤请参考 [Faceunity Nama 相关文档](https://github.com/Faceunity/FULivePC/blob/master/docs/Windows_Nama_SDK_%E9%9B%86%E6%88%90%E6%8C%87%E5%AF%BC%E6%96%87%E6%A1%A3.md)。

## 第三步：视频图像处理

1. 调用 [`setParameters`](https://doc.yunxin.163.com/nertc/references/windows/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine_ex.html#a4d39a81643f19979461ec0bb569f4a0d) 接口，将 `kNERtcKeyEnableVideoCaptureObserver` 的值设置为 `YES`，开启摄像头采集数据的回调。

    ::: note note
    - V5.3.0 及之后版本需要执行该步骤。
    - V4.6.X 版本请忽略该步骤。
    :::

2. 在成功加入房间后，调用 <a href="https://doc.yunxin.163.com/nertc/references/windows/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#ad958fcb663c93a8c84d516effc50e863" target="_blank">`enableLocalVideo`</a> 方法开启本地视频采集，并设置 `NERtcVideoStreamType` 为 `kNERTCVideoStreamMain`，否则美颜效果不会生效。

3. 在代理方法 <a href="https://doc.yunxin.163.com/nertc/references/windows/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine_event_handler_ex.html#ad0423dae090d924f82a8765bacca3365" target="_blank">`onCaptureVideoFrame`</a> 中，将原始视频图像数据通过回调发给相芯美颜的接口，做相应的美颜处理。

    相关参数的含义如下：

    参数名称 | 参数含义 |
    -- | -- |
    data | 采集视频数据 |
    type | 视频类型 |
    width | 视频宽度。
    height | 视频高度 |
    count | 视频 plane count |
    offset | 视频 offset |
    stride | 视频 stride |
    rotation | 视频旋转角度 |

4. 调用相芯美颜的接口，从 NERTC 回调中获取原始视频图像数据，对视频图像数据进行美颜处理，美颜后的视频数据再通过参数返回给 NERTC 代理。

    **示例代码**

    ```C++
    std::string params("{\"enable_video_capture_observer\":1}");
    rtcEngine->setParameters(params.c_str());

    rtcEngine->enableLocalVideo(nertc::kNERTCVideoStreamMain, true);

    void onCaptureVideoFrame(void *data,
        NERtcVideoType type,
        uint32_t width,
        uint32_t height,
        uint32_t count,
        uint32_t offset[kNERtcMaxPlaneCount],
        uint32_t stride[kNERtcMaxPlaneCount],
        NERtcVideoRotation rotation)
    {
        //请自行实现美颜相关逻辑
    }
    ```

## 第四步：设置美颜效果

美颜、美妆、滤镜、贴纸效果的具体参数设置，请参考 [Faceunity Nama 相关文档](https://github.com/Faceunity/FULivePC/tree/master/docs)。

## API 参考

| **方法** | **功能描述** |
| :-- | :-- |
| <a href="https://doc.yunxin.163.com/nertc/references/windows/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#ad958fcb663c93a8c84d516effc50e863" target="_blank">`enableLocalVideo`</a> | 开启本地视频采集。 |
| <a href="https://doc.yunxin.163.com/nertc/references/windows/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine_ex.html#a4d39a81643f19979461ec0bb569f4a0d" target="_blank">`setParameters`</a> | 设置摄像头采集数据的回调。 |
| <a href="https://doc.yunxin.163.com/nertc/references/windows/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine_event_handler_ex.html#ad0423dae090d924f82a8765bacca3365" target="_blank">`onCaptureVideoFrame`</a> | 视频帧数据回调。 |

## 常见问题

### 使用美颜后画面会闪一下，怎么办？

- **可能原因**：相芯 7.x.x 版本 SDK 前 5 帧存在渲染问题。

- **解决方案**：

    - 升级相芯版本至 8.x.x 版本。
    - 若不想升级相芯版本，在美颜处理时，建议您丢弃前 5 帧。

### 使用美颜后画面出现闪屏、黑屏，怎么办？

- **可能原因**：美颜拿到了采集的过程数据没拿到结果数据。
- **解决方案**：
    - 初始化相芯 SDK 时，调用 `fuSetUseTexAsync(true)` 方法。
    - 升级 NERTC SDK 至 4.6.50 及以后的版本。详情请参考 [升级指南](https://doc.yunxin.163.com/nertc/guide/TMxMjc1NDU?platform=windows)。

### 使用美颜后出现画面卡顿，怎么办？

- **可能原因 1**：采集帧率设置太高，例如 30 帧，美颜也会按照 30 帧率进行处理。在一些低端机上，高帧率会对整个系统产生较大的压力，美颜处理时间可能会超过每一帧预期的帧间隔，引发画面卡顿。
- **解决方案**：降低采集帧率，在 NERTC SDK 的视频配置中，将帧率设置为 15。

- **可能原因 2**：相芯 SDK 日志级别太低，导致每处理一帧都会打印大量日志，影响整体性能。
- **解决方案**：在初始化时，关闭相芯 SDK 日志，将日志级别设置为 `OFF`。

    ```C++
    fuSetLogLevel(FU_LOG_LEVEL_OFF);
    ```