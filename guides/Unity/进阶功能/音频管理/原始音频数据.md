<!-- 实时音视频,原始音频数据,前处理,后处理 -->

NERTC SDK 的音频模块会严格控制声音设备的采集和播放逻辑，同时支持对采集到的音视频原始数据进行自定义的前处理和后处理，获取想要的播放效果。适用于非标设备接入、自定义音频效果、语音处理、语音识别等场景。

- 前处理：在音频数据发送到编码器前获取原始的音频数据进行修改，主要针对本地麦克风采集到的音频数据或自定义外部音频流。
- 后处理：即在音频数据发送给解码器后获取原始的音频数据进行修改，主要针对接收到的远端用户音频数据。

NERTC SDK 通过提供 `IAudioFrameObserver` 类，实现采集、修改原始音频数据功能。

## <span id="注意事项">注意事项</span>

- 采集回调 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#add0110e57c83bd076dbd6e1d081c7193" target="_blank">`OnAudioFrameDidRecord`</a>、播放回调 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#ac387847cd374133c444a68cf4c9f1bb5" target="_blank">`OnAudioFrameWillPlayback`</a> 中的原始音频数据可进行处理，例如美声变声。
- 混音回调 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#a01e02adff2d3f15e0923123156a8321f" target="_blank">`OnMixedAudioFrame`</a> 和某一用户的播放回调 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#a62e2fe2c6b7ed7122041169606acfc16" target="_blank">`OnPlaybackAudioFrameBeforeMixing`</a> 中的原始音频数据不能进行处理。

## 前提条件

在使用原始数据处理功能前，请确保您已在项目中实现基本的实时音视频功能。

## 技术原理

![rawdata.png](https://yx-web-nosdn.netease.im/common/f8a4905ffdeeea44a923db651bbfe74e/rawdata.png)

## <span id="Windows/macOS实现方法">实现方法</span>

### **API 调用时序**

以实现修改采集音频的音频数据为例，API 调用时序如下图所示。

@startuml
!include https://raw.githubusercontent.com/bschwarz/puml-themes/master/themes/cerulean-outline/puml-theme-cerulean-outline.puml
skinparam backgroundColor #FFFFFF

应用层 -> NERtcSDK: SetAudioFrameObserver
应用层 -> NERtcSDK: SetRecordingAudioFrameParameters
NERtcSDK --> 应用层: OnAudioFrameDidRecord
note over 应用层, NERtcSDK #FFAAAA: 自行处理音频数据
应用层 -> NERtcSDK: OnAudioFrameDidRecord
@enduml

### **配置步骤**

1. 加入房间前基于 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html" target="_blank">`IAudioFrameObserver`</a> 接口类实现一个 **NERtcAudioFrameObserver** 类，并调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#abb5f3d0ee4660fa61dbd1a9c21de2f9a" target="_blank">`SetAudioFrameObserver`</a> 方法注册语音观测器。

2. 设置回调的音频采样率。

    - 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a6a66d26b40ad2259678d2fe9df178d65" target="_blank">`SetRecordingAudioFrameParameters`</a> 方法修改回调的采集音频采样率，并将回调的音频数据设置为只读模式或读写模式。
    - 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#acd5a9d31d3b54fadd87c4e0a1f9e584f" target="_blank">`SetPlaybackAudioFrameParameters`</a> 方法修改回调的播放音频采样率，并将回调的音频数据设置为只读模式或读写模式。
    - 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a46b4c668c2f466470a722ca5226f0b2a" target="_blank">`SetMixedAudioFrameParameters`</a> 方法，设置 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#a01e02adff2d3f15e0923123156a8321f" target="_blank">`OnMixedAudioFrame`</a> 回调中的混音音频采样率。

3. SDK 返回回调。

    - SDK 收到输入的采集数据和播放的音频数据时，返回 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#add0110e57c83bd076dbd6e1d081c7193">`OnAudioFrameDidRecord`</a> 和 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#ac387847cd374133c444a68cf4c9f1bb5" target="_blank">`OnAudioFrameWillPlayback`</a> 回调。
    - SDK 收到音频采集与播放混合后数据帧时，返回 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#a01e02adff2d3f15e0923123156a8321f" target="_blank">`OnMixedAudioFrame`</a> 回调；SDK 收到某一远端用户播放的音频数据时，返回 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#a62e2fe2c6b7ed7122041169606acfc16" target="_blank">`OnPlaybackAudioFrameBeforeMixing`</a> 回调。

4. 用户拿到音频数据后，需要根据场景自行进行处理。
5. 完成音频数据处理后，您可以直接进行自播放，或根据场景需求再通过 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#add0110e57c83bd076dbd6e1d081c7193">`OnAudioFrameDidRecord`</a> 和 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#ac387847cd374133c444a68cf4c9f1bb5" target="_blank">`OnAudioFrameWillPlayback`</a> 回调发送给 SDK。

### <span id="示例代码">**示例代码**</span>

```C#
    public class AudioFrameCallback : IAudioFrameObserver
    {
        public void OnAudioFrameDidRecord(RtcAudioFrame frame)
        {
            //
        }

        public void OnAudioFrameWillPlayback(RtcAudioFrame frame)
        {
            //
        }

        public void OnMixedAudioFrame(RtcAudioFrame frame)
        {
            //
        }

        public void OnPlaybackAudioFrameBeforeMixing(ulong userId, RtcAudioFrame frame, ulong cid)
        {
            //
        }
    }
    private void setAudioFrameObserver()
    {
        int result = rtcEngine.SetAudioFrameObserver(new AudioFrameCallback());
        if(result  != (int)RtcErrorCode.kNERtcNoError)
        {
            //失败
        }
    }
```

## API 参考
| **方法** | **功能描述**|
|:--|:--|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a6a66d26b40ad2259678d2fe9df178d65" target="_blank">`SetRecordingAudioFrameParameters`</a>|设置回调的采集音频采样率|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#acd5a9d31d3b54fadd87c4e0a1f9e584f" target="_blank">`SetPlaybackAudioFrameParameters`</a>|设置回调的播放音频采样率|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a46b4c668c2f466470a722ca5226f0b2a" target="_blank">`SetMixedAudioFrameParameters`</a> |设置回调的混音音频采样率|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#abb5f3d0ee4660fa61dbd1a9c21de2f9a" target="_blank">`SetAudioFrameObserver`</a>|注册语音观测器|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#add0110e57c83bd076dbd6e1d081c7193">`OnAudioFrameDidRecord`</a>| 接收本端输入的采集音频数据回调|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#ac387847cd374133c444a68cf4c9f1bb5" target="_blank">`OnAudioFrameWillPlayback`</a>|接收本端输入的播放音频数据播放回调|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#a01e02adff2d3f15e0923123156a8321f" target="_blank">`OnMixedAudioFrame`</a>|接收采集与播放音频混合数据帧回调|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_audio_frame_observer.html#a62e2fe2c6b7ed7122041169606acfc16" target="_blank">`OnPlaybackAudioFrameBeforeMixing`</a>|接收远端播放的音频数据帧回调|