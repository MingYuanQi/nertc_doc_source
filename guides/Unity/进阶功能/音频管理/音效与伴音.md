<!--keywords:音视频通话,音效,伴音,混音 -->

在音视频通话或直播场景中，默认情况下只有房间成员本人说话的人声。出于烘托气氛、营造多样化语音环境的需求，NERTC SDK 支持通过混音功能播放多个掌声、口哨等短时音效，或者为人声添加背景音乐、伴奏音乐或其他场景效果，并将合成后的声音播放给房间内其他成员。

## <span id="功能概述">功能概述</span>

混音，指 SDK 从 App 获取一路音频数据，将 App 提供的音频数据与 SDK 采集的音频数据整合为一路音频数据，通常用于音乐直播、在线KTV、连麦PK、游戏直播等场景。

NERTC SDK 提供混音相关方法，实现播放短时音效和背景音乐的功能。

- 播放短时音效：
  
  指通话或直播中播放短时音频文件，一般用于渲染房间气氛，例如游戏音效、掌声、口哨、欢呼声、笑声的短时音效。支持多个音效叠加播放。

- 播放背景音乐：

  伴音功能支持在房间中播放本地或者在线音乐文件，作为通话或直播时的背景声音，同时让房间内的其他人听到此音乐。NERTC 播放伴音方法可以用来播放比较长的背景音，例如伴奏音乐、环境白噪声、背景音乐等等。

NERTC SDK 混音功能支持如下设置：

- 混音：支持将音乐文件的音频流跟麦克风采集的音频流（主流）进行叠加并编码发送给对方，同时伴音功能支持通过辅流通道传输音乐文件的音频流。

- 循环：可以设置是否循环播放混音文件，以及循环次数。

- 音量控制：可以各自控制本地播放以及编码发送的混音音量。
- 音调控制：可以按伴音音阶调整本地播放的音乐文件的音调。例如在 K 歌场景中，为了使歌曲更适合主播的声线音域，主播可以调整伴音的音调，升高或降低伴奏的音阶。

- 定位：混音任务支持从背景音乐文件的任意位置开始播放。

- 叠加：可以同时播放多个短时音效文件。

## <span id="注意事项">注意事项</span>

- 伴音相关方法的返回值若小于 0，表示方法调用失败。
- 请在加入房间成功后再启动混音任务。
- 本地混音文件支持 MP3、M4A、AAC、3GP、WMA、WAV 格式，支持本地文件和在线 URL。
- 可通过 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/namespacenertc.html#afa4e132abdcef1d23530289de6a08797" target="_blank">`OnAudioMixingStateChanged`</a> 回调接收音乐文件播放状态改变的相关信息，如果播放出错，可通过对应错误码排查故障。

## <span id="配置音效">配置音效</span>

### 配置步骤

1. 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a17ecbcde0460bec9c530ea0608cf8da4" target="_blank">`PlayEffect`</a> 方法播放指定 `effectId` 的音效文件。调用此方法时，您需要设置 `option` 参数指定播放的音效文件。相关参数的含义如下。	
    - `path`：指定音效文件的路径，例如 `D:\\audio_files\\test.mp3`。支持本地绝对路径或 URL 地址。
    - `effectId`：指定音效文件的 ID。
    - `loopCount`：指定音效文件循环播放的次数。默认值为 1，即默认仅播放一次；若该值小于等于0，则默认为无限循环播放。
    - `sendEnabled`：是否将音效发送至远端。该参数的默认值为 YES，即远端用户可以听到该音效。
    - `sendVolume`：音效文件的发送音量。该参数的取值范围为 0 ~ 100，默认值为 100，表示使用文件的原始音量。
    - `playbackEnabled`：是否本地播放该音效。默认为 YES，即本地用户可以听到该音效。
    - `playbackVolume`：音效文件的播放音量。该参数的取值范围为 0 ~ 100，默认值为 100，表示使用文件的原始音量。

    ::: note note
    - 您可以多次调用此方法以同时播放多个音效文件，实现音效的叠加。
    - 在调用此方法成功播放指定音效文件后，若您反复停止再重新播放该 `effectId` 对应的音效文件，首次播放时设置的 `option` 无效，会恢复为默认值。
    :::

2. 音效播放任务管理。开始播放音效后，您还可以通过其他方法实现音效播放任务管理等更多功能，例如：	
    - **进度管理**：调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#aa416c0c3c71f0d8b2719aff88d62b4e3" target="_blank">`PauseAllEffects`</a> 方法暂停播放所有音效、调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#ac9ed947880055042012f0b36d55068d6" target="_blank">`ResumeAllEffects`</a> 方法恢复播放所有音效、调用 [`SetEffectPosition`](https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/V5.4.5/zh/html/classnertc_1_1_i_rtc_engine.html#a8d13d01f0a590bc2d9be0034849049ff) 方法设置音效文件的播放位置等，此外也可以通过注册 [`OnAudioEffectTimestampUpdate`](https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/V5.4.5/zh/html/namespacenertc.html#a3e21c91c43d5f423de1a3d898ca09d2d) 回调以监听音效文件的实时播放进度。
    - **音量管理**：调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a17ecbcde0460bec9c530ea0608cf8da4" target="_blank">`SetEffectSendVolume`</a> 方法设置音效文件发送音量、调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#aaa393e72a8aa306072b2636b8eba66c5" target="_blank">`SetEffectPlaybackVolume`</a> 方法设置音效文件播放音量。
    - **音调管理**：调用 [`SetEffectPitch`](https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/V5.4.5/zh/html/classnertc_1_1_i_rtc_engine.html#ab3b5459e745cc36c713fd900c4463aee) 方法并通过 `pitch` 参数设置音效文件的音调。

        ::: note note
        - 仅开始播放音效文件后可调用此方法；播放结束后，音调将恢复为默认值。
        - 音调 `pitch` 参数的取值范围为 [-12,12]，默认值为 0，每相邻两个值的音调高度相差半音；取值的绝对值越大，音调升高或降低得越多。
        - 若 SDK 返回 30003，表示参数设置错误；若 SDK 返回 30005，表示引擎尚未初始化或未找到当前音效文件。
        :::
    - **获取混音相关信息**：调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a4cf8821e26ea90024cbdff09a4019e06" target="_blank">`GetEffectSendVolume`</a> 方法获取音效文件发送音量、调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a56f2a3c23240244530dc86e888f02b4c" target="_blank">`GetEffectPlaybackVolume`</a> 方法获取音效文件播放音量等。

3. 在离开房间前，调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a70df8196e8ffed03f96e6cd53b9c646d" target="_blank">`StopAllEffects`</a> 方法结束播放所有音效。

### 示例代码

```C#
uint effectId = 0;//音效唯一ID，需要自己指定 
//播放音效
private void playEffect()
{
    // 调用 playEffect 播放指定的音效文件
    var option = new RtcCreateAudioEffectOption
    {
        path = "/path/to/file", //e.g. D:/tes.mp3
        loopCount = 1,
        sendEnabled = true,
        playbackEnabled = true,
        sendVolume = 100,
        playbackVolume = 100,
        streamType = RtcAudioStreamType.kNERtcAudioStreamTypeMain,
        startTimestamp = 0,
        progressInterval = 1000,
    };
    
    int result = rtcEngine.PlayEffect(effectId, option);
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }
}
//调整音量
private void setEffectVolume()
{
    //设置发送音量
    int result = rtcEngine.SetEffectSendVolume(effectId, 90);
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }

    //设置播放音量
    result = rtcEngine.SetEffectPlaybackVolume(effectId, 90);
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }
}
//停止播放音效
private void stopEffect()
{
    int result = rtcEngine.StopEffect(effectId);
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }
}
//停止所有音效
private void stopAllEffects()
{
    int result = rtcEngine.StopAllEffects();
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }
}
```

### API 参考

| **方法** | **功能描述**|
|:--|:--|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a17ecbcde0460bec9c530ea0608cf8da4" target="_blank">`PlayEffect`</a>|播放指定音效文件|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#aa3108885fe1d9e63ce154d363e013f49" target="_blank">`StopEffect`</a>|停止播放指定音效文件|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a94112d68121107bea0ba2e20d9446c57" target="_blank">`PauseEffect`</a>|暂停播放指定音效文件|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#af285f7c8223fc13435164525192cde5f" target="_blank">`ResumeEffect`</a>|恢复播放指定音效文件|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a70df8196e8ffed03f96e6cd53b9c646d" target="_blank">`StopAllEffects`</a>|停止播放所有音效文件|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#aa416c0c3c71f0d8b2719aff88d62b4e3" target="_blank">`PauseAllEffects`</a>|暂停播放所有音效文件|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#ac9ed947880055042012f0b36d55068d6" target="_blank">`ResumeAllEffects`</a>|恢复播放所有音效文件|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a4cf8821e26ea90024cbdff09a4019e06" target="_blank">`GetEffectSendVolume`</a>|获取音效文件的发送音量|
|[`SetEffectPitch`](https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/V5.4.5/zh/html/classnertc_1_1_i_rtc_engine.html#ab3b5459e745cc36c713fd900c4463aee) | 设置音效的音调|
|[`GetEffectPitch`](https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/V5.4.5/zh/html/classnertc_1_1_i_rtc_engine.html#a2ea1217c7d8d629abceb3b9555249012)|获取音效的音调|
<br>


| **事件** | **事件描述** |
|:--|:--|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/namespacenertc.html#a3ee8f1a7732a3fd254d42cdcc3b6e0a6" target="_blank">`OnAudioEffectFinished`</a>|本地音效文件播放已结束回调|

## 配置伴音

### 配置步骤

1. 初始化伴音配置类，通过 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/structnertc_1_1_rtc_create_audio_mixing_option.html" target="_blank">`RtcCreateAudioMixingOption`</a> 设置伴音任务相关参数，例如伴音文件路径、是否本地播放、是否通过辅流通道传输等等。
2. 加入房间成功后，调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a6fdf5cb89e0d44b75ba509b89533b88a" target="_blank">`StartAudioMixing`</a> 方法开始伴音。
3. 伴音任务管理。开始伴音后，还可以通过其他方法实现伴音任务管理等更多功能，例如：
    - **进度管理**: 调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a292e82d26b561cca0316251033bf8a49" target="_blank">`PauseAudioMixing`</a> 和 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#ad9e26302a02470577512a4f5b25b8cde" target="_blank">`ResumeAudioMixing`</a> 方法暂停或恢复伴音、调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a59deddcafd92f81c0bba9a29cb5bede6" target="_blank">`SetAudioMixingPosition`</a> 设置伴音文件的播放进度。
    - **音量管理**：调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a8946b4fec0811154363c4aa90d83c6aa" target="_blank">`SetAudioMixingPlaybackVolume`</a> 和 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a646d9703c71356c5b3c2ac2b9ecc9dcc" target="_blank">`SetAudioMixingSendVolume`</a> 等方法设置伴音的播放音量、伴音的发送音量。
    - **音调管理**：调用 [`SetAudioMixingPitch`](https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/V5.4.5/zh/html/classnertc_1_1_i_rtc_engine.html#a29a4febf3dccbe08301496a679d43f8a) 方法并通过 `pitch` 参数设置伴音文件的音调。

      ::: note note
      - 仅开始伴音后可调用此方法；伴音结束后，音调将恢复为默认值。
      - 音调 `pitch` 参数的取值范围为 [-12,12]，默认值为 0，每相邻两个值的音调高度相差半音；取值的绝对值越大，音调升高或降低得越多。
      - 若 SDK 返回 30003，表示参数设置错误；若 SDK 返回 30005，表示引擎尚未初始化或未找到当前伴音文件。
      :::    
    - **获取伴音相关信息**：例如通过 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a1b4142d3b5695e4c3e2ffc5621b4a753" target="_blank">`GetAudioMixingCurrentPosition`</a> 等接口获取伴音文件的播放进度等。
4. 在离开房间前调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a9a6572dfca1f4d198d8be7ce88c66fc2" target="_blank">`StopAudioMixing`</a> 方法结束伴音。

### <span id="示例代码">示例代码</span>

```C#
//开启伴音
private void startAudioMixing()
{
    // 调用 playEffect 播放指定的音效文件
    var option = new RtcCreateAudioMixingOption
    {
        path = "D:\\audioFiles\\test.mp3",
        loopCount = 1,
        sendEnabled = true,
        playbackEnabled = true,
        sendVolume = 100,
        playbackVolume = 100,
        streamType = RtcAudioStreamType.kNERtcAudioStreamTypeMain,
        startTimestamp = 0,
        progressInterval = 1000,
    };
    //开启伴音
    int result = rtcEngine.StartAudioMixing(option);
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }

    
}
//获取当前播放进度
private void GetAudioMixingCurrentPosition()
{
    //获取总时长
    ulong duration = 0;
    int result = rtcEngine.GetAudioMixingDuration(ref duration);
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }
    //获取当前播放位置
    ulong currentPostion = 0;
    result = rtcEngine.GetAudioMixingCurrentPosition(ref currentPostion);
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }
}
//调整伴音音量
private void setAudioMixingVolume()
{
    //设置发送音量
    uint sendVolume = 90;
    int result = rtcEngine.SetAudioMixingSendVolume(sendVolume);
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }
    //获取发送音量
    result = rtcEngine.GetAudioMixingSendVolume(ref sendVolume);
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }
    //设置播放音量
    uint playbackVolume = 90;
    result = rtcEngine.SetAudioMixingPlaybackVolume(playbackVolume);
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }
    //获取播放音量
    result = rtcEngine.GetAudioMixingPlaybackVolume(ref playbackVolume);
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }
}
//停止播放音效
private void stopAudioMixing()
{
    int result = rtcEngine.StopAudioMixing();
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }
}
```

### <span id="API参考">API参考</span>

| **方法** | **功能描述**|
|:--|:--|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a6fdf5cb89e0d44b75ba509b89533b88a" target="_blank">`StartAudioMixing`</a>|开始播放伴音|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a9a6572dfca1f4d198d8be7ce88c66fc2" target="_blank">`StopAudioMixing`</a>|停止播放伴音|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a292e82d26b561cca0316251033bf8a49" target="_blank">`PauseAudioMixing`</a>|暂停播放伴音|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#ad9e26302a02470577512a4f5b25b8cde" target="_blank">`ResumeAudioMixing`</a>|恢复播放伴音|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a8946b4fec0811154363c4aa90d83c6aa" target="_blank">`SetAudioMixingPlaybackVolume`</a>|设置伴音播放音量|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a646d9703c71356c5b3c2ac2b9ecc9dcc" target="_blank">`SetAudioMixingSendVolume`</a>|设置伴音的发送音量|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#ad17a8b09fc33de2453433ffc1212b98e" target="_blank">`GetAudioMixingPlaybackVolume`</a>|获取伴音的播放音量|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a75c2cc517d53e545d901ba2057a3823a" target="_blank">`GetAudioMixingSendVolume`</a>|获取伴音的发送音量|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#af09767d2e9a7f44993aeb1d86ab95165" target="_blank">`GetAudioMixingDuration`</a>|获取伴音的总长度|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a59deddcafd92f81c0bba9a29cb5bede6" target="_blank">`SetAudioMixingPosition`</a>|设置伴音的播放进度|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a1b4142d3b5695e4c3e2ffc5621b4a753" target="_blank">`GetAudioMixingCurrentPosition`</a>|获取伴音当前播放进度|
|[`SetAudioMixingPitch`](https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/V5.4.5/zh/html/classnertc_1_1_i_rtc_engine.html#a29a4febf3dccbe08301496a679d43f8a)|设置伴音的音调|
|[`GetAudioMixingPitch`](https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/V5.4.5/zh/html/classnertc_1_1_i_rtc_engine.html#afad8b86e929fa4c577bd49e185c1adc0)|获取伴音的音调|

<br>


| **事件** | **事件描述** |
|:--|:--|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/namespacenertc.html#afa4e132abdcef1d23530289de6a08797" target="_blank">`OnAudioMixingStateChanged`</a>|伴音播放状态改变回调|
|<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/namespacenertc.html#a9c9525a22e64f6a4699418c0cd78d729" target="_blank">`OnAudioMixingTimestampUpdate`</a>|伴音播放进度回调|
