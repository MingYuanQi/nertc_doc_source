<!--keywords: 质量监测,质量数据回调,网络状态,统计数据 -->
在通话场景中，开发者经常需要了解当前通话的通话质量、设备状态等信息，监测通话的整体体验；也可将部分质量数据在 UI 层面展示给用户，使用户能够及时了解当前通话的整体质量。NERTC SDK 支持将关键的音视频状况、网络状况、设备状态的相关指标实时回调给 APP 应用层，应用层可以将收到的数据进行展示或统计。

例如，在进行多人连麦时，您可以展示用户的实时网络质量，如下图所示。

<img style="width:400px" src=" https://yx-web-nosdn.netease.im/common/bc9cb52f00e1948491c5666d6db5c5c0/网络显示.png " alt="文本">

## <span id="功能介绍">功能介绍</span>

NERTC SDK 提供注册质量监测观测器 [`IMediaStatsObserver`](https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html) 的接口与相关回调方法，支持在通话中实时同步并返回质量数据，包括上下行网络质量、本地通话统计信息、本地和远端的音视频流统计信息等。

## 实现方法

调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#abd07f8bae8af8903b1f272ef1371984f" target="_blank">`SetStatsObserver`</a> 方法注册质量观测器，主动设置相应回调，回调名称与返回的质量数据信息的对应关系如下表所示。

| 回调 | 统计信息 |
| -- | -- |
| <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html#af89d1abe764b23a6670a88621751fd9e" target="_blank">`OnNetworkQuality`</a> | [上下行网络质量同步](#上下行网络质量同步) |
| <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html#a30c8218bddefc0a494086704847017d1" target="_blank">`OnRtcStats`</a> | [统计信息同步](#统计信息同步) |
| <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html#a610f8389a6a8f3675ae32b0c2d1603cc" target="_blank">`OnLocalAudioStats`</a>、<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html#a0c2faaba75b54d69c66145e79d1fb340" target="_blank">`OnRemoteAudioStats`</a> | [音频质量同步](#音频质量同步) |
| <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html#ac981562f20527a440203bea561d44e0f" target="_blank">`OnLocalVideoStats`</a>、<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html#ae573bdaaf6cd4a6996b29da3bb1ef3a9" target="_blank">`OnRemoteVideoStats`</a> | [视频质量同步](#视频质量同步) |

::: note note
若您需要关闭质量监测功能，传入 `null` 即可。
:::

**示例代码**如下：

```C#
//定义统计信息上报监听类
public class MediaStatsObserver : IMediaStatsObserver
{
    public void OnLocalAudioStats(object channelOrEngine, RtcAudioSendStats stats)
    {
        //TODO:
    }

    public void OnLocalVideoStats(object channelOrEngine, RtcVideoSendStats stats)
    {
        //TODO:
    }

    public void OnNetworkQuality(object channelOrEngine, RtcNetworkQualityInfo[] infos)
    {
        //TODO:
    }

    public void OnRemoteAudioStats(object channelOrEngine, RtcAudioRecvStats[] stats)
    {
        //TODO:
    }

    public void OnRemoteVideoStats(object channelOrEngine, RtcVideoRecvStats[] stats)
    {
        //TODO:
    }

    public void OnRtcStats(object channelOrEngine, RtcStats stats)
    {
        //TODO:
    }
}
private void setMediaStatsObserver()
{
    //设置统计上报数据回调
    int result = rtcEngine.SetStatsObserver(new MediaStatsObserver());
    if (result != (int)RtcErrorCode.kNERtcNoError)
    {
        //失败
    }

    //如果不再需要取消监听
    rtcEngine.SetStatsObserver(null);
}
```

## <span id="上下行网络质量同步">上下行网络质量同步</span>

<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html#af89d1abe764b23a6670a88621751fd9e" target="_blank">**`OnNetworkQuality`**</a> 回调以数组的形式向您同步当前通话中每个成员的上下行网络质量。
- 上行网络质量打分基于实际发送码率、上行网络丢包率、平均往返时延和上行网络抖动计算。
- 下行网络质量打分基于下行网络丢包率、平均往返时延和下行网络抖动计算。

::: note note
- 每隔 2 秒您会收到房间内所有用户的网络质量同步。
- 实际发送码率与目标发送码率的比值越高，该网络下的通话质量越好，该网络质量打分越高。
:::

[**`RtcNetworkQualityInfo`**](https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/structnertc_1_1_rtc_network_quality_info.html) 数组中各参数的说明如下表所示。

<table>
<tr>
    <th width="30%">参数</th>
    <th width="70%">参数说明</th>
</tr>
    <tr>
    <td>uid</td>
    <td>用户 ID，指定是哪个用户的网络质量统计。</td>
</tr>
    <tr>
    <td>txQuality</td>
    <td>该用户的上行网络质量。</td>
</tr>
    <tr>
    <td>rxQuality</td>
    <td>该用户的下行网络质量。</td>
</tr>
</table>

其中网络质量 [**`RtcNetworkQualityType`**](https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/namespacenertc.html#ab143de899f0796d7eff30a454fa142b3) 的各枚举值如下表所示。

<table>
<tr>
    <th width="30%">枚举值</th>
    <th width="70%">说明</th>
</tr>
    <tr>
    <td>kNERtcNetworkQualityUnknown</td>
    <td>当前网络质量未知。</td>
</tr>
    <tr>
    <td>kNERtcNetworkQualityExcellent</td>
    <td>当前网络质量极好。</td>
</tr>
    <tr>
    <td>kNERtcNetworkQualityGood</td>
    <td>当前网络状态不错。</td>
</tr>
    <tr>
    <td>kNERtcNetworkQualityPoor</td>
    <td>当前网络状态一般。</td>
</tr>
    <tr>
    <td>kNERtcNetworkQualityBad</td>
    <td>当前网络状态比较差，可能出现卡顿和网络延迟。</td>
</tr>
    <tr>
    <td>kNERtcNetworkQualityVeryBad</td>
    <td>当前网络状态非常差，无法保证正常的通话质量。</td>
</tr>
    <tr>
    <td>kNERtcNetworkQualityDown</td>
    <td>完全无法沟通。</td>
</tr>
</table>

## <span id="统计信息同步">统计信息同步</span>

<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html#a30c8218bddefc0a494086704847017d1" target="_blank">**`OnRtcStats`**</a> 回调向您同步本地通话统计信息。其中包含通话时长、当前通话房间中的人数、当前系统的 CPU 使用率、当前 App 的 CPU 使用率等重要数据。

<table>
    <tbody>
    <tr>
        <th width="30%">参数</th>
        <th width="70%">参数说明</th>
    </tr>
        <tr>
            <td>cpuAppUsage、cpuIdleUsage、cpuTotalUsage</td>
            <td>App 的 CPU 使用率、系统的 CPU 空闲率和系统的 CPU 使用率。</td>
        </tr>
        <tr>
            <td>memoryAppUsage、memoryAppKbytes、memoryTotalUsage</td>
            <td>App 的内存使用率、内存使用量、系统的内存使用率</td>
        </tr>
        <tr>
            <td>totalDuration</td>
            <td>通话总时长，单位为秒。</td>
        </tr>
        <tr>
            <td>txBytes/rxBytes</td>
            <td>累计发送/接收字节数。</td>
        </tr>
        <tr>
            <td>txAudioBytes/rxAudioBytes</td>
            <td>音频发送/接收字节数。</td>
        </tr>
        <tr>
            <td>txVideoBytes/rxVideoBytes</td>
            <td>视频发送/接收字节数。</td>
        </tr>
        <tr>
            <td>txAudioKbitrate/rxAudioKbitrate</td>
            <td>音频接收/发送码率，单位为 Kbps。</td>
        </tr>
        <tr>
            <td>txVideoKbitrate/rxVideoKbitrate</td>
            <td>视频接收/发送码率，单位为 Kbps。</td>
        </tr>
        <tr>
            <td>upRtt/downRtt</td>
            <td>上行/下行平均往返时延，单位为毫秒。</td>
        </tr>
        <tr>
            <td>txAudioPacketLossRate/rxAudioPacketLossRate</td>
            <td>本地上行/下行音频实际丢包率。</td>
        </tr>
        <tr>
            <td>txAudioPacketLossSum/rxAudioPacketLossSum</td>
            <td>本地上行/下行音频实际丢包数。</td>
        </tr>
        <tr>
            <td>txAudioJitter/rxAudioJitter</td>
            <td>本地上行/下行音频抖动计算，单位为毫秒。</td>
        </tr>
        <tr>
            <td>txVideoJitter/rxVideoJitter</td>
            <td>本地上行/下行视频抖动计算，单位为毫秒。</td>
        </tr>
        <tr>
            <td>txVideoPacketLossRate/rxVideoPacketLossRate</td>
            <td>本地上行/下行视频实际丢包率。</td>
        </tr>
        <tr>
            <td>txVideoPacketLossSum/rxVideoPacketLossSum</td>
            <td>本地上行/下行视频实际丢包数。</td>
        </tr>
    </tbody>
</table>

## <span id="音频质量同步">音频质量同步</span>

### <span id="本地音频流统计信息同步">本地音频流统计信息同步</span>

<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html#a610f8389a6a8f3675ae32b0c2d1603cc" target="_blank">**`OnLocalAudioStats`**</a> 回调向您同步本地设备发送音频流的统计信息，包括当前通话声道数（单声道或双声道）、发送音频的采样率和发送音频的码率。SDK 会每隔 2 秒自动触发本回调。

<table>
    <tr>
        <th width="20%"><b>参数</b></th>
        <th width="40%"><b>参数说明</b></th>
    </tr>
    <tr>
        <td>numChannels</td>
        <td>当前采集的声道数。</td>
    </tr>
    <tr>
        <td>sentSampleRate</td>
        <td>统计周期内本地上行音频采样率，单位为 Hz。</td>
    </tr>
    <tr>
        <td>sentBitrate</td>
        <td>统计周期内发送码率的平均值，单位为 Kbps。</td>
    </tr>
    <tr>
        <td>audioLossRate</td>
        <td>特定时间内的音频丢包率。</td>
    </tr>
    <tr>
        <td>rtt</td>
        <td>平均往返时延（RTT）。</td>
    </tr>
    <tr>
        <td>volume</td>
        <td>音量，取值范围为 0 ~ 100。</td>
    </tr>
</table>

### <span id="远端音频流统计信息同步">远端音频流统计信息同步</span>

<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html#a0c2faaba75b54d69c66145e79d1fb340" target="_blank">**`OnRemoteAudioStats`**</a> 回调向您同步当前通话中每个远端用户音频流的统计信息，包括每个远端用户发送的音频流质量、声道数等信息。SDK 会每隔 2 秒自动触发本回调。

<table>
    <tbody>
    <tr>
        <th width="30%">参数</th>
        <th width="70%">参数说明</th>
    </tr>
        <tr>
            <td>uid</td>
            <td>用户 ID，指定是哪个用户的音频流。</td>
        </tr>
        <tr>
            <td>receivedBitrate</td>
            <td>统计周期内接收到的码率平均值，单位为 Kbps。</td>
        </tr>
        <tr>
            <td>totalFrozenTime</td>
            <td>远端用户在加入房间后发生音频卡顿的累计时长，单位为毫秒。一个统计周期内，音频丢帧率达到 4% 即记为一次音频卡顿。</td>
        </tr>
        <tr>
            <td>frozenRate</td>
            <td>远端用户下行音频平均卡顿率。其值为远端用户在加入房间后发生音频卡顿的累计时长占音频总有效时长的百分比。</td>
        </tr>
        <tr>
            <td>audioLossRate</td>
            <td>统计周期内的远端音频流的丢帧率。</td>
        </tr>
        <tr>
            <td>volume</td>
            <td>音量，取值范围为 0 ~ 100。</td>
        </tr>
    </tbody>
</table>

## <span id="视频质量同步">视频质量同步</span>

### <span id="本地视频流统计信息同步">本地视频流统计信息同步</span>

<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html#ac981562f20527a440203bea561d44e0f" target="_blank">**`OnLocalVideoStats`**</a> 回调向您同步本地设备发送视频流的统计信息，包括视频编码宽/高等信息。SDK 会每隔 2 秒自动触发本回调。

若您此前调用 <a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/classnertc_1_1_i_rtc_engine.html#a754c8049a7872c4bd0d9cecb0117958f" target="_blank">`EnableDualStreamMode`</a> 方法开启了双流模式，则本回调描述本地设备发送的视频大流的统计信息。

<table>
    <tbody>
    <tr>
        <th width="30%">参数</th>
        <th width="70%">参数说明</th>
    </tr>
        <tr>
            <td>layerType</td>
            <td>视频流通道类型。<li>1：主流。<li>2：辅流。</td>
        </tr>
        <tr>
            <td>width</td>
            <td>视频编码宽度，单位为 px。</td>
        </tr>
        <tr>
            <td>height</td>
            <td>视频编码高度，单位为 px。</td>
        </tr>
        <tr>
            <td>captureFrameRate</td>
            <td>视频采集帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>renderFrameRate</td>
            <td>视频渲染帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>encoderFrameRate</td>
            <td>编码帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>sentFrameRate</td>
            <td>实际发送帧率，单位为 fps，不包含丢包后重传视频等的发送帧率。</td>
        </tr>
        <tr>
            <td>sentBitrate</td>
            <td>实际发送码率，单位为 Kbps，不包含丢包后重传视频等的发送码率。</td>
        </tr>
        <tr>
            <td>targetBitrate</td>
            <td>当前编码器的目标编码码率，单位为 Kbps，该码率为 SDK 根据当前网络状况预估的一个值。</td>
        </tr>
        <tr>
            <td>encoderBitrate</td>
            <td>编码器实际编码码率，单位为 Kbps。</td>
        </tr>
        <tr>
            <td>codecName</td>
            <td>视频编码器的名称。</td>
        </tr>
    </tbody>
</table>

### <span id="远端视频流统计信息同步">远端视频流统计信息同步</span>

<a href="https://doc.yunxin.163.com/nertc/api-refer/unity/doxygen/Latest/zh/html/interfacenertc_1_1_i_media_stats_observer.html#ae573bdaaf6cd4a6996b29da3bb1ef3a9" target="_blank">**`OnRemoteVideoStats`**</a> 回调向您同步当前通话中每个远端用户/主播的视频流的统计信息，包括每个远端用户的视频宽/高等其他参数信息。SDK 会每隔 2 秒自动触发本回调。

<table>
    <tbody>
    <tr>
        <th width="30%">参数</th>
        <th width="70%">参数说明</th>
    </tr>
        <tr>
            <td>layerType</td>
            <td>视频流通道类型。<li>1：主流。<li>2：辅流。</td>
        </tr>
        <tr>
            <td>width</td>
            <td>远端视频编码宽度，单位为 px。</td>
        </tr>
        <tr>
            <td>height</td>
            <td>远端视频编码高度，单位为 px。</td>
        </tr>
        <tr>
            <td>receivedBitrate</td>
            <td>接收到的码率，单位为 Kbps。</td>
        </tr>
        <tr>
            <td>receivedFrameRate</td>
            <td>接收到的帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>decoderFrameRate</td>
            <td>解码帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>renderFrameRate</td>
            <td>渲染帧率，单位为 fps。</td>
        </tr>
        <tr>
            <td>packetLossRate</td>
            <td>远端视频下行丢包率。</td>
        </tr>
        <tr>
            <td>totalFrozenTime</td>
            <td>远端用户加入房间后，其下行视频卡顿累计时长，单位为毫秒。</td>
        </tr>
        <tr>
            <td>frozenRate</td>
            <td>远端用户加入房间后，其下行视频平均卡顿率，其值为视频卡顿的累计时长占视频总有效时长的百分比。</td>
        </tr>
        <tr>
            <td>codecName</td>
            <td>视频编码器的名称。</td>
        </tr>
    </tbody>
</table>


