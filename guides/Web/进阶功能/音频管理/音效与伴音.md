在音视频通话或直播场景中，默认情况下只有房间成员本人说话的人声。出于烘托气氛、营造多样化语音环境的需求，NERTC SDK 支持通过混音功能播放多个掌声、口哨等短时音效，或者为人声添加背景音乐、伴奏音乐或其他场景效果，并将合成后的声音播放给房间内其他成员。

<style>
table th:first-of-type {width: 35%;}
</style>

## <span id="功能概述">功能概述</span>

混音，指 SDK 从 App 获取一路音频数据，将 App 提供的音频数据与 SDK 采集的音频数据整合为一路音频数据，通常用于音乐直播、在线 KTV、连麦 PK、游戏直播等场景。

网易云信 NERTC SDK 提供混音相关方法，实现播放短时音效和背景音乐的功能。

- **播放短时音效**：

    指通话或直播中播放短时音频文件，一般用于渲染房间气氛，例如游戏音效、掌声、口哨、欢呼声、笑声的短时音效。支持多个音效叠加播放。

- **播放背景音乐**：

    伴音功能支持在房间中播放本地或者在线音乐文件，作为通话或直播时的背景声音，同时让房间内的其他人听到此音乐。NERTC 播放伴音方法可以用来播放比较长的背景音，例如伴奏音乐、环境白噪声、背景音乐等等。

网易云信 NERTC SDK 混音功能支持如下设置：

- **混音**：混音指的是音乐文件的音频流跟麦克风采集的音频流进行混音（叠加）并编码发送给对方。
- **循环**：可以设置是否循环播放混音文件，以及循环次数。
- **音量控制**：可以各自控制本地播放以及编码发送的混音音量。
- **定位**：混音任务支持从背景音乐文件的任意位置开始播放。
- **叠加**：可以同时播放多个短时音效文件。

## 示例项目

网易云信在 GitHub 上提供设置 <a href="https://github.com/netease-im/G2-API-Examples/tree/main/web/sampleCode-Vue/SoundEffect-Web-Vue" target="_blank">音效</a> 和 <a href="https://github.com/netease-im/G2-API-Examples/tree/main/web/sampleCode-Vue/AudioMixing-Web-Vue" target="_blank">伴音</a> 的开源示例项目，您可以参考源码进行集成开发，也可以在 web 页面在线体验 <a href="https://app.yunxin.163.com/webdemo/g2web/index.html#/?path=soundEffect" target="_blank">音效</a> 和 <a href="https://app.yunxin.163.com/webdemo/g2web/index.html#/?path=mixSound" target="_blank">伴音</a> 功能。

## <span id="注意事项">注意事项</span>

- Web 端 NERTC SDK 在 H5 平台不支持以下伴音相关 API：`startAudioMixing`、`stopAudioMixing`、`pauseAudioMixing`、`resumeAudioMixing`、`adjustAudioMixingVolume`、`getAudioMixingDuration`。如果您调用了这些 API，SDK 会报错 BROWSER_NOT_SUPPORT。
- 伴音相关方法的返回值若小于 0，表示方法调用失败。
- 请在加入房间成功后再启动混音任务。
- 本地混音文件支持 MP3、M4A、AAC、3GP、WMA、WAV 格式，支持在线 URL。

## <span id="配置音效">配置音效</span>

### 配置步骤

1. （可选）在加入房间后调用 [preloadEffect](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#preloadeffect) 方法，将待播放音效加载至内存，以供您后续快速播放该音效文件。调用此方法时，您需要设置 filePath 和 soundId 指定预加载的音效文件。两个参数的含义如下。

    参数 | 说明 |
    ---- | ---- |
    filePath | 指定在线音效文件的相对或绝对路径，即 URL 地址。<br>支持 MP3、AAC 以及浏览器支持的其他音频格式。 |
    soundId | 指定音效文件的 ID。<br>该参数为正整数，取值范围为 1 ~ 10000。 |

2. 调用 [playEffect](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#playeffect) 方法播放指定 soundId 的音效文件。调用此方法时，您需要设置 filePath、soundID 等参数指定播放的音效文件。相关参数的含义如下。

    参数 | 说明 |
    ---- | ---- |
    filePath | 指定在线音效文件的相对或绝对路径，即 URL 地址。<br>支持 MP3、AAC 以及浏览器支持的其他音频格式。 |
    soundId | 指定音效文件的 ID。<br>该参数为正整数，取值范围为 1 ~ 10000。 |
    cycle | 指定音效文件循环播放的次数。<br>该参数为正整数，取值范围为 1 ~ 10000，默认值为 1，即默认仅播放一次。 |

    ::: note note
    您可以多次调用此方法以同时播放多个音效文件，实现音效的叠加。
    :::

3. 音效播放任务管理。开始播放音效后，您还可以通过其他方法实现音效播放任务管理等更多功能，例如：
    - **进度管理**：调用 [pauseAllEffects](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#pausealleffects) 方法暂停播放所有音效、调用 [resumeAllEffects](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#resumealleffects) 方法恢复播放所有音效。
    - **音量管理**：调用 [setEffectsVolume](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#seteffectsvolume) 方法设置音效文件的播放音量。
    - **获取混音相关信息**：例如通过调用 [getAudioEffectsDuration](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#getaudioeffectsduration)、[getAudioEffectsCurrentPosition](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#getaudioeffectscurrentposition) 等方法获取音效文件时长或当前播放进度等。
    - 在离开房间前，调用 [stopAllEffects](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#stopalleffects) 方法结束播放所有音效。

### 示例代码

```JavaScript
// 调用 preloadEffect
// soundId 指定音效的 ID。每个音效均有唯一的 ID。正整数，取值范围为 [1,10000]。
// filePath 必须，指定在线音效文件的绝对路径(支持 MP3，AAC 以及浏览器支持的其他音频格式。)
rtc.localStream.preloadEffect(soundId, filePath)
    .then(res=>{
    console.log('预加载音效文件成功: ', res)
    }).catch(err=>{
    console.error('预加载音效文件失败: ', err)
    })

 // 调用 playEffect
 // 注意，如果 filePath 指向其他域名下的文件，则该音频文件需进行跨域配置
 let options = {
    filePath, // 必须，指定在线音效文件的绝对路径(支持 MP3，AAC 以及浏览器支持的其他音频格式。)
    cycle, // 可选，指定音效文件循环播放的次数
    soundId // 指定音效的 ID。每个音效均有唯一的 ID。
 }

rtc.localStream.playEffect({
    filePath,
    cycle,
    soundId
    }).then(res=>{
    console.log('音效文件播放成功: ', res)
    }).catch(err=>{
    console.error('播放音效文件失败: ', err)
    })

// 调用 pauseAllEffects 暂停所有音效播放
rtc.localStream.pauseAllEffects()
    .then(res=>{
    console.log('pauseAllEffects 成功')
    }).catch(err=>{
    console.error('pauseAllEffects 失败: ', err)
    })

// 调用 resumeAllEffects 恢复所有音效播放
rtc.localStream.resumeAllEffects()
    .then(res=>{
      console.log('resumeAllEffects 成功')
    }).catch(err=>{
      console.error('resumeAllEffects 失败: ', err)
    })

// 调用 getAudioEffectsDuration 获取音效文件时长
let audioEffectsDuration = rtc.localStream.getAudioEffectsDuration({filePath,soundId})

// 调用 getAudioEffectsCurrentPosition 获取当前音效播放进度
let audioEffectsCurrentPosition = rtc.localStream.getAudioEffectsCurrentPosition({filePath,soundId})

// 调用 stopAllEffects 结束音效播放
rtc.localStream.stopAllEffects()
    .then(res=>{
      console.log('stopAllEffects 成功', res)
    }).catch(err=>{
      console.error('stopAllEffects 失败: ', err)
    })
```

### API 参考

| 方法 | 功能描述 |
| :-- | :-- |
| [preloadEffect](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#preloadeffect) | 预加载指定音效文件 |
| [unloadEffect](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#unloadeffect) | 释放指定音效文件 |
| [playEffect](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#playeffect) | 播放指定音效文件 |
| [stopEffect](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#stopeffect) | 停止播放指定音效文件 |
| [pauseEffect](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#pauseeffect) | 暂停播放指定音效文件 |
| [resumeEffect](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#resumeeffect) | 恢复播放指定音效文件 |
| [stopAllEffects](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#stopalleffects) | 停止播放所有音效文件 |
| [pauseAllEffects](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#pausealleffects) | 暂停播放所有音效文件 |
| [resumeAllEffects](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#resumealleffects) | 恢复播放所有音效文件 |
| [setVolumeOfEffect](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#setvolumeofeffect) | 设置指定音效文件的播放音量 |
| [setEffectsVolume](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#seteffectsvolume) | 设置所有音效文件的播放音量 |
| [getEffectsVolume](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#geteffectsvolume) | 获取所有音效文件的播放音量 |
| [getAudioEffectsDuration](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#getaudioeffectsduration) | 获取音效文件的时长 |
|[getAudioEffectsCurrentPosition](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#getaudioeffectscurrentposition) | 获取音效文件的播放进度 |
| [stopAllEffects](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#stopalleffects) | 停止播放所有音效文件 |

## 配置伴音

### 配置步骤

1. 加入房间成功后，调用 [startAudioMixing](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html//interfaces/stream.stream-1.html#startaudiomixing) 创建伴音任务。

2. 伴音任务管理。开始伴音后，还可以通过其他方法实现伴音任务管理等更多功能，例如：

    - **进度管理**：通过 [pauseAudioMixing](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html//interfaces/stream.stream-1.html#pauseaudiomixing) 和 [resumeAudioMixing](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html//interfaces/stream.stream-1.html#resumeaudiomixing) 暂停或恢复伴音、通过 [setAudioMixingPosition](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#setaudiomixingposition) 设置伴音文件的播放进度。
    - **音量管理**：通过 [adjustAudioMixingVolume](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html//interfaces/stream.stream-1.html#adjustaudiomixingvolume) 调整伴音音量。
    - **获取混音相关信息**：例如通过 [getAudioMixingDuration](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html//interfaces/stream.stream-1.html#getaudiomixingduration) 获取伴音文件的时长，通过 [getAudioMixingCurrentPosition](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html//interfaces/stream.stream-1.html#getaudiomixingcurrentposition) 获取当前播放进度等。

3. 在离开房间前调用 [stopAudioMixing](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html//interfaces/stream.stream-1.html#stopaudiomixing) 结束伴音。

<span id="示例代码"></span>

### 本端设置伴音示例

以下代码示例展示了如何在远端播放伴音，使房间内其他成员也能听到该伴音：

```JavaScript
//开始伴音
const audioMixingEndHandler = function(event){
  console.warn('伴音结束: ', event)
}

const options = {
  audioFilePath: '"someaudio.mp3"', // 必须，在线音乐文件的 URL 地址
  loopback: false, // 是否循环播放音频文件
  replace: false, // 是否替换麦克风采集的音频
  cycle: 0, // 循环播放次数，默认为 0，表示无限循环
  playStartTime: 0, // 播放起始位置，单位为秒，默认为 0，即从头开始播放。
  auidoMixingEnd: audioMixingEndHandler // 伴音结束回调
}
localStream.startAudioMixing(options).then(res=>{
  console.log('伴音成功')
}).catch(err=>{
  console.error('伴音失败: ', err)
})

//暂停伴音
localStream.pauseAudioMixing().then(res=>{
  console.log('暂停伴音成功')
}).catch(err=>{
  console.error('暂停伴音失败: ', err)
})

//恢复伴音
localStream.resumeAudioMixing().then(res=>{
  console.log('恢复伴音成功')
}).catch(err=>{
  console.error('恢复伴音失败: ', err)
})

//停止伴音
localStream.stopAudioMixing().then(res=>{
  console.log('停止伴音成功')
}).catch(err=>{
  console.error('停止伴音失败: ', err)
})
```

### 本地播放伴音示例

以下代码示例展示了如何仅在本端以 `'music'` 模式播放（[`play`](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html//interfaces/stream.stream-1.html#play)）伴音，只有自己能听到该伴音：

```JavaScript
//开始伴音
const audioMixingEndHandler = function(event){
  console.warn('伴音结束: ', event)
  localStream.stop('audio')
}

const options = {
  audioFilePath: '"someaudio.mp3"',
  loopback: false,
  replace: false,
  cycle: 0,
  playStartTime: 0,
  auidoMixingEnd: audioMixingEndHandler
}
localStream.startAudioMixing(options).then(res=>{
  console.log('伴音成功')
  localStream.play(null, { audio: true, audioType: 'music' }) // 将 audioType 设置为 music 模式播放
}).catch(err=>{
  console.error('伴音失败: ', err)
})
```

### API 参考

| 方法 | 功能描述 |
| :-- | :-- |
| [startAudioMixing](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#startaudiomixing) | 开始播放音乐文件和本地麦克风声音的混合 |
| [pauseAudioMixing](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#pauseaudiomixing) | 暂停播放音乐文件 |
| [resumeAudioMixing](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#resumeaudiomixing) | 恢复播放音乐文件 |
| [stopAudioMixing](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#stopaudiomixing) | 停止播放音乐文件 |
| [adjustAudioMixingVolume](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#adjustaudiomixingvolume) | 调节音乐文件音量 |
| [getAudioMixingDuration](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#getaudiomixingduration) | 获取音乐文件时长 |
| [getAudioMixingCurrentPosition](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#getaudiomixingcurrentposition) | 获取音乐文件当前播放进度 |
| [setAudioMixingPosition](https://doc.yunxin.163.com/nertc/references/web/typedoc/Latest/zh/html/interfaces/stream.stream-1.html#setaudiomixingposition) | 设置音乐文件的播放进度 |

## 常见问题

### 为什么我开启伴音效果后，对方听不清我的人声？

答：一般是因为您设置的伴音音量和人声音量不合理，导致接收端的音频效果较差。网易云信建议您调用 `setCaptureVolume` 方法设置采集音量为 100，即不对信号做缩放。且调用 adjustAudioMixingVolume 方法设置的混音播放音量不超过 25，否则伴音过程中语音沟通的体验会受到影响。

### <span id="Safari 浏览器，开启和关闭麦克风时，当前正在播放的声音会在扬声器和听筒间切换">Safari 浏览器，开启和关闭麦克风时，当前正在播放的声音会在扬声器和听筒间切换</span>

**问题现象**

iOS Safari 15 版本浏览器接入 NERTC，页面正在播放声音（例如播放背景音乐），NERTC 调用接口开启和关闭麦克风，当前正在播放的音频输出会在扬声器和听筒间切换，并且声音大小也会改变。

**问题原因**

网易云信 NERTC SDK 调用 `getUserMedia` 获取麦克风权限，或通过 `mictrack.stop()` 关闭麦克风时，会影响页面上正在播放的 `<audio>` 标签，导致 `<audio>` 标签播放的声音会在扬声器和听筒间切换，并且声音大小也会改变。具体请参考 [WebKit Bug 236439](https://bugs.webkit.org/show_bug.cgi?id=236439)。

**问题解决**

iOS Safari 15 版本浏览器接入 NERTC SDK 时，建议您使用 NERTC SDK 的 **伴音** 功能来播放背景音，而不是使用 `<audio>` 标签。